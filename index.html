<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LTS Web Control</title>
  <link rel="icon" type="image/png" href="/LogoFavicon.png" />

  <style>
    :root {
      --bg: 242 242 247;
      --text: 17 17 17;
      --accent: #0E7AFE;
      --accent-dark: #1364C4;
      --action-font: 1.1rem;

      --flasher-bg: 255 255 255;
      --flasher-text: 17 17 17;
      --background-secondary: 255 255 255;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: 15 17 21;
        --text: 234 234 234;

        --flasher-bg: 28 28 30;
        --flasher-text: 234 234 234;
        --background-secondary: 44 44 46;
      }
    }

    body {
      margin: 0;
      background: rgb(var(--bg));
      color: rgb(var(--text));
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      padding: 1rem;
      line-height: 1.3;
      max-width: 1100px;
      margin-inline: auto;

      /* Vertically center without causing overflow from padding */
      min-height: 100vh;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    button {
      -webkit-tap-highlight-color:  transparent;
      font-family: inherit;
    }

    .header {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 1.1rem;
    }

    .header-logo img {
      max-height: 120px;
      height: auto;
      width: auto;
      max-width: 100%;
      display: block;
    }

    .header-text {
      margin-top: 0.4rem;
    }

    h1 {
      margin-top: 0rem;
      margin-bottom: 0.2rem;
      font-size: 2rem;
      text-align: center;
      white-space: nowrap;
    }


    /* Top status pills (UI only) */
    .status-pills {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      justify-content: stretch;
      gap: 14px;
      margin-top: 0;
      margin-bottom: 0;
    }

    .status-pill {
      background: #ffffff;
      border-radius: 28px; /* match card border radius */
      padding: 0 13px;
      height: 56px;
      min-height: 56px;
      display: flex;
      align-items: center;
      gap: 12px;
      border: none;
      box-sizing: border-box; /* prevent size change when border appears */
    }

    @media (prefers-color-scheme: dark) {
      .status-pill {
        background: rgb(28,28,30);
        border: 1px solid rgba(255,255,255,0.18); /* match dark divider color */
      }
    }

    @media (prefers-color-scheme: dark) {
      #lts-update select,
      #lts-update input[type="password"],
      #lts-update input[type="text"] {
        background: rgba(255,255,255,0.08);
        color: rgb(var(--text));
        border-color: rgba(255,255,255,0.18);
      }
    }

    .status-pill svg {
      width: 28px;
      height: 28px;
      flex: 0 0 28px;
      color: rgb(var(--text));
      opacity: 0.95;
    }
    .status-emoji {
      font-size: 1.6rem;
      line-height: 1;
      flex: 0 0 auto;
    }

    .status-pill-text {
      display: flex;
      flex-direction: column;
      line-height: 1.05;
      min-width: 0;
    }

    .status-pill-title {
      font-size: 1.1rem;      /* match .lts-btn */
      font-weight: 600;       /* match .lts-btn */
      letter-spacing: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-pill-subtitle {
      margin-top: 4px;
      font-size: 1.1rem;      /* match settings card text */
      font-weight: 400;
      opacity: 0.45;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 450px) {
      .status-pill svg {
        width: 24px;
        height: 24px;
        flex-basis: 24px;
      }
      .status-pill-title,
      .status-pill-subtitle {
        font-size: 1.0rem;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 28px;
      padding: 1rem;
      margin-top: 0;
      border: none;
      box-sizing: border-box; /* prevent size change when border appears */
    }

    /* Slightly tighter top padding for the Control card */
    .card.control-card {
      padding-top: 0.6rem;
    }

    @media (prefers-color-scheme: dark) {
      .card {
        background: rgb(28,28,30);
        border: 1px solid rgba(255,255,255,0.18); /* match dark divider color */
      }
    }

    /* Pill-style card (e.g. Speed) */
    .card.pill-card {
      padding: 0 16px;
      height: 56px;
      min-height: 56px;
      display: flex;
      align-items: center;
    }


    /* Two-column layout for Control + Settings cards */
    .cards-row {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 0.8rem; /* spacing below the status pills */
      align-items: stretch;
    }

    /* Stack multiple cards inside the left column (Control + Speed) */
    .card-stack {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
      height: 100%;
    }

    .info-card {
      flex: 1 1 auto;
      min-height: 0;
      padding: 0;
      overflow: hidden;
      position: relative;
      display: flex;
      container-type: size;
      flex-direction: column;
      justify-content: flex-end;

      /* image + footer sizing vars */
      --info-img-pad: 1rem;
      --info-footer-pad: 16px;
      --info-btn-h: 40px;
      --info-gap: 10px;
      --info-meta-gap: 1rem;
      --info-footer-total: calc(var(--info-footer-pad) + var(--info-btn-h) + var(--info-footer-pad) + var(--info-gap));
      --info-img-size: min(
        calc(100cqw - (var(--info-img-pad) * 2)),
        calc(100cqh - (var(--info-img-pad) * 2) - var(--info-footer-total))
      );
    }

    .info-card::before {
      content: "";
      position: absolute;
      top: var(--info-img-pad);
      left: var(--info-img-pad);
      width: var(--info-img-size);
      height: var(--info-img-size);
      background-image: url("Respooler.png");
      background-repeat: no-repeat;
      background-position: left center; /* leading */
      background-size: contain;
      background-origin: content-box;
      background-clip: content-box;
      padding: 0.7rem;
      border: 1px solid #d1d5db;
      border-radius: 12px;
      box-sizing: border-box;
      pointer-events: none;
      z-index: 0;
    }

    .info-meta {
      position: absolute;
      top: var(--info-img-pad);
      left: calc(var(--info-img-pad) + var(--info-img-size) + var(--info-meta-gap));
      width: calc(100% - (var(--info-img-pad) + var(--info-img-size) + var(--info-meta-gap) + var(--info-img-pad)));
      height: var(--info-img-size);
      z-index: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 10px;
      min-width: 0;
      pointer-events: none;
    }

    .info-meta-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .info-meta-label {
      font-size: 0.95rem;
      font-weight: 600;
      opacity: 0.55;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .info-meta-value {
      font-size: 1.1rem;
      font-weight: 600;
      line-height: 1.15;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-variant-numeric: tabular-nums;
    }

    @media (max-width: 450px) {
      .info-meta-label { font-size: 0.9rem; }
      .info-meta-value { font-size: 1.0rem; }
    }

    .info-card-footer {
      position: relative;
      z-index: 1;
      padding: var(--info-footer-pad);
      padding-top: calc(var(--info-footer-pad) + var(--info-gap));
    }

    .info-card-footer-row {
      display: flex;
      align-items: stretch;
      gap: 12px;
      width: 100%;
    }

    .info-connect-btn {
      height: var(--info-btn-h);
      padding: 0 1.0rem;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 1 1 auto;
      width: auto;
    }

    .info-wifi-btn {
      height: var(--info-btn-h);
      border-radius: 12px;
      padding: 0 1.0rem;
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      font-size: var(--action-font);
    }
    /* Ensure Info-card WiFi button matches Connect button sizing */
    button.info-wifi-btn {
      height: var(--info-btn-h);
      border-radius: 12px;
      padding: 0 1.0rem;
      font-size: var(--action-font);
    }

    /* Keep spacer class for compatibility (not used now) */
    .card-stack-spacer {
      flex: 1 1 auto;
    }

    @media (max-width: 870px) {
      .cards-row {
        grid-template-columns: 1fr;
      }
    }

    /* When screen height is small, place header logo + title side-by-side (like Web Flasher) */
    @media (max-height: 870px) {
      body {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }

      .header {
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 1rem;
      }

      .header-logo img {
        max-height: 80px;
        max-width: 38vw;
      }

      .header-text {
        margin-top: 0;
        text-align: left;
      }

      .header-text h1 {
        text-align: left;
      }
    }

    @media (max-width: 400px) and (max-height: 870px) {
      .header {
        gap: 0.5rem;
      }
    }

    @media (max-width: 450px) and (max-height: 870px) {
      .header-logo img {
        max-width: 100px;
      }
    }

    /* Slightly lift the whole layout when header is stacked (default). */
    .page-content {
      transform: translateY(-18px);
    }

    /* When header is side-by-side (small height), don't lift the content. */
    @media (max-height: 870px) {
      .page-content {
        transform: none;
      }
    }

    /* Web Flasher Button-Style */
    .lts-btn {
      padding: 0.85rem 1.5rem;
      border-radius: 14px;
      background-color: #1a1a1a;
      color: #fff !important;
      border: none;
      font-size: var(--action-font);
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .lts-btn:disabled {
      background-color: #1a1a1a;
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Spezifische Farben für Control-Buttons (Block A) */
    #wbConnect, #wbConnect:hover, #wbConnect:active, #wbConnect[disabled] {
      background:#1a1a1a !important;   /* black in light mode */
      color:#ffffff !important;
      border:none !important;
      box-shadow:none !important;
      -webkit-appearance:none;
      appearance:none;
    }

    @media (prefers-color-scheme: dark) {
      /* Match Web Flasher connect button styling */
      #wbConnect, #wbConnect:hover, #wbConnect:active {
        background: rgb(var(--text)) !important; /* same "white" as flasher */
        color: #000000 !important;
      }
      #wbConnect[disabled] {
        background: rgba(234, 234, 234, 0.7) !important;
        color: #000000 !important;
      }
    }

    #wbStart, #wbStart:hover, #wbStart:active, #wbStart[disabled] {
      background:#d1e9ff !important;
      color:#0088fe !important;
      border:none !important;
      box-shadow:none !important;
      -webkit-appearance:none;
      appearance:none;
    }
    @media (prefers-color-scheme: dark) {
      #wbStart, #wbStart:hover, #wbStart:active, #wbStart[disabled] {
        background:#153a56 !important;
      }
    }

    #wbStop, #wbStop:hover, #wbStop:active, #wbStop[disabled] {
      background:#ffdbdc !important;
      color:#fe383c !important;
      border:none !important;
      box-shadow:none !important;
      -webkit-appearance:none;
      appearance:none;
    }
    @media (prefers-color-scheme: dark) {
      #wbStop, #wbStop:hover, #wbStop:active, #wbStop[disabled] {
        background:#492326 !important;
      }
    }

    /* Progress bar (Block A, leicht angepasst) */
    #wbProg {
      width:100%;
      height:14px;
      background:#e5e7eb;
      border-radius:9999px;
      overflow:hidden;
      margin:10px 0 12px 0;
    }
    @media (prefers-color-scheme: dark) {
      #wbProg {
        background: rgba(255,255,255,0.08);
      }
    }
    .section-divider {
      border: 0;
      border-top: 1px solid #d1d5db;
    }

    @media (prefers-color-scheme: dark) {
      .section-divider {
        border-top-color: rgba(255,255,255,0.18);
      }
    }

    @media (prefers-color-scheme: dark) {
      .info-card::before {
        border-color: rgba(255,255,255,0.18);
      }
    }
    #wbProgBar {
      height:100%;
      width:0%;
      background:#0c4c98;
      transition: width 0.35s ease, background-color 0.35s ease, background 0.35s ease;
      will-change: width, background-color;
    }
    @media (prefers-reduced-motion: reduce) {
      #wbProgBar { transition: none; }
    }

    #wbStatusText {
      display:inline-block;
      will-change: opacity, transform;
    }
    #wbProgPct,
    #wbStatusText,
    #wbProgRem {
      font-size: 1.1rem;
    }
    @media (prefers-reduced-motion: reduce) {
      #wbStatusText { transition: none !important; }
    }

    /* Block B – zusätzliche Styles */
    /* Typography for settings card (match Web Flasher sizing) */
    #lts-settings label,
    #lts-settings select,
    #lts-settings input[type="range"],
    #lts-settings input[type="checkbox"],
    #lts-settings span,
    #lts-settings #speedVal {
      font-size: 1.1rem;
    }
    /* Typography for speed card (match settings card sizing) */
    #lts-speed label,
    #lts-speed input[type="range"],
    #lts-speed span,
    #lts-speed #speedVal {
      font-size: 1.1rem;
    }
    /* Custom accent color for sliders and checkmarks */
    input[type="range"],
    input[type="checkbox"] {
      accent-color: #1364C4;
    }
    @media (prefers-color-scheme: dark) {
      input[type="range"],
      input[type="checkbox"] {
        accent-color: #1364C4;
      }
    }

    /* Kleine Typo-Anpassungen für schmale Screens */
    @media (max-width: 450px) {
      h1 { font-size: 1.9rem; }
      .header-logo img { max-width: 60px; }
      :root { --action-font: 1.0rem; }
      .lts-btn {
        font-size: 1.0rem;
      }
      #wbProgPct,
      #wbStatusText,
      #wbProgRem {
        font-size: 1.0rem;
      }
      #lts-settings label,
      #lts-settings select,
      #lts-settings input[type="range"],
      #lts-settings input[type="checkbox"],
      #lts-settings span,
      #lts-settings #speedVal {
        font-size: 1.0rem;
      }
      #lts-speed label,
      #lts-speed input[type="range"],
      #lts-speed span,
      #lts-speed #speedVal {
        font-size: 1.0rem;
      }
    }

    /* --- Servo calibration modal --- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 9999;
    }
    .modal-backdrop.show { display: flex; }

    .modal {
      width: min(480px, 100%);
      background: #ffffff;
      border-radius: 31px;
      padding: 1rem;
      box-shadow: 0 18px 50px rgba(0,0,0,0.22);
      border: 1px solid #d1d5db; /* match section divider color */
      position: relative;
    }
    @media (prefers-color-scheme: dark) {
      .modal {
        background: rgb(28,28,30);
        border: 1px solid rgba(255,255,255,0.18); /* match dark divider color */
      }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 0.75rem;
      position: relative;
      padding-right: 44px;   /* reserve space for the close button */
    }
    .modal-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 0;
      line-height: 30px; /* match close button height for exact vertical centering */
    }

    .icon-btn {
      border: none;
      background: #e5e7eb; /* match grey buttons */
      color: rgb(var(--text));
      font-size: 1.7rem;
      width: 30px;
      height: 30px;
      padding-bottom: 6px;
      border-radius: 9999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    @media (prefers-color-scheme: dark) {
      .icon-btn {
        background: rgba(255,255,255,0.14);
      }
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      transform: none;
      z-index: 20;           /* ensure it stays above modal header/contents */
      pointer-events: auto;  /* ensure it can receive clicks */
    }

    .mini-btn {
      border: none;
      border-radius: 12px;
      padding: 0.55rem 0.75rem;
      font-size: 1.0rem;
      font-weight: 600;
      cursor: pointer;
      background: #e5e7eb; /* match segmented picker background */
      color: rgb(var(--text));
      -webkit-appearance: none;
      appearance: none;
    }

    /* Compact mini button for text-only actions (e.g. Calibrate) */
    .mini-btn.compact {
      height: 34px;              /* match +/- buttons visual height */
      padding: 0 0.75rem;        /* no vertical padding */
      border-radius: 10px;       /* match +/- buttons */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: auto;               /* shrink to fit content */
      min-width: 0;
      white-space: nowrap;
    }
    @media (prefers-color-scheme: dark) {
      .mini-btn { background: rgba(255,255,255,0.14); }
    }
    .mini-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .stepper {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      justify-self: start;
    }

    /* Segmented +/- control like iOS (grey background, non-pill radius) */
    .stepper-seg {
      display: inline-flex;
      align-items: stretch;
      height: 26px;
      border-radius: 10px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .stepper-seg-btn {
      width: 33px;
      border: none;
      background: transparent;
      color: rgb(var(--text));
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-size: 1.8rem;
      line-height: 1;
    }

    .stepper-seg-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .stepper-seg-divider {
      width: 1px;
      background: #d1d5db; /* same as dividers */
    }

    @media (prefers-color-scheme: dark) {
      .stepper-seg {
        background: rgba(255,255,255,0.14);
        border-color: rgba(255,255,255,0.18);
      }
      .stepper-seg-divider {
        background: rgba(255,255,255,0.18);
        opacity: 1;
      }
    }
    .stepper .stepper-glyph {
      display: inline-block;
      position: relative;
      top: -1.7px; /* adjust this value (+/- px) to move the glyph */
    }
    .stepper-value {
      text-align: left;              /* align like other settings values */
      font-variant-numeric: tabular-nums;
      font-size: 1.05rem;
    }

    .modal .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      align-items: center;
      column-gap: 0px;
      width: 100%;
      margin: 0;
      margin-top: 10px;
    }
    .modal .row label { text-align: right; padding-right: 12px; }
    .modal .row input[type="range"] { width: min(260px, 100%); justify-self: start; }

    .segmented {
      display: flex;
      padding: 0.2rem;
      background: #e5e7eb;
      border-radius: 14px;
      width: 100%;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      margin-top: 0;
    }

    .segmented.is-disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    @media (prefers-color-scheme: dark) {
      .segmented {
        background: rgba(255,255,255,0.08);
      }
    }

    .seg-indicator {
      position: absolute;
      top: 0.25rem;
      left: 0.25rem;
      height: calc(100% - 0.5rem);
      width: calc(50% - 0.25rem);
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      transform: translateX(0%);
      transition: transform 0.25s ease;
      pointer-events: none;
    }
    @media (prefers-color-scheme: dark) {
      .seg-indicator {
        background: rgba(255,255,255,0.14);
      }
    }

    .seg-btn {
      flex: 1 1 0;
      padding: 0.4rem 0.9rem;
      border: none;
      background: transparent;
      font-size: 1.1rem;
      font-weight: 400;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      position: relative;
      color: rgb(var(--text));
      transition: background 0.25s ease, box-shadow 0.25s ease;
      -webkit-appearance: none;
      appearance: none;
    }
    .seg-btn.is-selected {
      font-weight: 600; /* selected state emphasis, matches Web Flasher */
    }
    .seg-btn:focus {
      outline: none;
    }

    .cal-row {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 64px 1fr 64px;
      align-items: center;
      gap: 12px;
    }
    .arrow-btn {
      border: none;
      border-radius: 10px;
      height: 52px;
      width: 64px;
      cursor: pointer;
      background: #e5e7eb; /* match segmented picker background */
      color: rgb(var(--text));
      -webkit-appearance: none;
      appearance: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      line-height: 1;
    }
    @media (prefers-color-scheme: dark) {
      .arrow-btn { background: rgba(255,255,255,0.14); }
    }
    .angle-text {
      text-align: center;
      font-size: 1.1rem;           /* match settings card text */
      font-weight: 400;            /* match settings card text */
      opacity: 1;                  /* same visual weight as settings */
      font-variant-numeric: tabular-nums;
    }
    /* --- Small UI utilities (no visual change) --- */
    .section-base {
      display: block;
      width: 100%;
      margin: 0;
      line-height: 1.5;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      color: rgb(var(--flasher-text));
    }
    .section-base.pos-rel { position: relative; }

    .section-control {
      max-width: none;
      padding-bottom: 0;
      border-radius: 18px;
      background: transparent;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      align-items: center;
      column-gap: 0px;
      width: 100%;
      margin: 0;
    }

    .form-label {
      text-align: right;
      padding-right: 12px;
    }

    .form-control {
      justify-self: start;
    }

    .ghost-divider {
      visibility: hidden;
      font-size: 20px;
      line-height: 1px;
      margin: 0;
      padding: 0;
    }

    .wb-topline {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      margin: 0;
    }

    .cal-desc {
      margin: 16px 0 0 0;
      opacity: 0.55;
      font-size: 1.05rem;
      line-height: 1.25;
    }
  </style>
</head>
<body>

  <div class="page-content">

  <div class="header">
    <div class="header-logo">
      <picture>
        <source srcset="Control-Logo-dark.png" media="(prefers-color-scheme: dark)" />
        <img src="Control-Logo.png" alt="Control Logo" />
      </picture>
    </div>
    <div class="header-text">
      <h1>LTS Web Control</h1>
    </div>
  </div>

  <div class="cards-row">

  <div class="card-stack">

  <!-- TOP STATUS PILLS (UI only) -->
  <div class="status-pills" aria-label="Status">
    <div class="status-pill">
      <img id="pillConnIcon" src="antenna-slash.png" alt="Connection" width="30" height="30" style="flex:0 0 30px;">
      <div class="status-pill-text">
        <div class="status-pill-title">Connection</div>
        <div id="pillConnSub" class="status-pill-subtitle">Disconnected</div>
      </div>
    </div>

    <div class="status-pill">
      <img id="pillFilIcon" src="xmark.png" alt="Filament" width="30" height="30" style="flex:0 0 30px;">
      <div class="status-pill-text">
        <div class="status-pill-title">Filament</div>
        <div id="pillFilSub" class="status-pill-subtitle">Not Detected</div>
      </div>
    </div>
  </div>

  <!-- INFO CARD (left column, fills available height) -->
  <div class="card info-card" aria-label="Control image">
    <div class="info-meta" aria-label="Board info">
      <div class="info-meta-row">
        <div class="info-meta-label">Board version</div>
        <div id="infoBoard" class="info-meta-value">—</div>
      </div>
      <div class="info-meta-row">
        <div class="info-meta-label">Respooler version</div>
        <div id="infoRespooler" class="info-meta-value">—</div>
      </div>
      <div class="info-meta-row">
        <div class="info-meta-label">Board firmware</div>
        <div id="infoFw" class="info-meta-value">—</div>
      </div>
      <div class="info-meta-row">
        <div class="info-meta-label">WiFi status</div>
        <div id="infoWifi" class="info-meta-value">—</div>
      </div>
    </div>
    <div id="wbConnectWrap" class="info-card-footer" style="display:none;">
      <div class="info-card-footer-row">
        <button id="wbConnect" class="lts-btn info-connect-btn" type="button">Connect Board</button>
        <button id="wifiModalBtn" class="mini-btn info-wifi-btn" type="button">Setup WiFi</button>
      </div>
    </div>
  </div>


  <!-- CONTROL CARD (Block A) -->
  <div class="card control-card">
    <section id="lts-control" class="section-base section-control">
      <p class="ghost-divider">---------------------------------------------------------------------</p>

      <div class="wb-topline">
        <span id="wbProgPct" style="justify-self:start;">0 %</span>
        <span id="wbStatusText" style="justify-self:center;">Not connected</span>
        <span id="wbProgRem" style="justify-self:end;">-00:00</span>
      </div>
      <div id="wbProg">
        <div id="wbProgBar"></div>
      </div>
      <div id="wbButtonGroup" style="display:none">
        <div class="lts-actions" style="display:flex;flex-wrap:nowrap;gap:12px;width:100%;align-items:stretch;margin:16px 0 0 0;">
          <button id="wbStart" class="lts-btn" style="flex:1 0 0;min-width:0;max-width:none;width:100%;" disabled>Start</button>
          <button id="wbStop"  class="lts-btn" style="flex:1 0 0;min-width:0;max-width:none;width:100%;" disabled>Stop</button>
        </div>
      </div>
      <div id="wbNoSupport" style="display:block; text-align:center; margin:16px 0 0 0; color:#ff8c28;">
        WebBluetooth is not supported in this browser. Please use Chrome or Edge on desktop or Android, or download the iOS app.
      </div>
    </section>
  </div>

  <!-- SPEED CARD -->
  <div class="card pill-card speed-card">
    <section id="lts-speed" class="section-base">

      <div style="display:grid; grid-template-columns:max-content 1fr max-content; align-items:center; column-gap:12px; width:100%; margin:0;">
        <label for="speed">Speed:</label>
        <input id="speed" type="range" min="50" max="100" step="1" value="85" style="width:100%;">
        <span id="speedVal" style="display:inline-block; width:6ch; text-align:right;">85 %</span>
      </div>
    </section>
  </div>

  </div>

    <div class="card-stack">


    <!-- SETTINGS CARD (Block B) -->
    <div class="card">
      <section id="lts-settings" class="section-base pos-rel">
      <p class="ghost-divider">---------------------------------------------------------------------</p>



      <div class="form-grid">
        <label for="led" class="form-label">LED Brightness:</label>
        <input id="led" class="form-control" type="range" min="0" max="100" step="10" value="50" style="width:min(160px, 100%); margin-top:2px;">
      </div>

      <div class="form-grid" style="margin-top:8px;">
        <label for="wgt" class="form-label">Transfer Amount:</label>
        <select id="wgt" class="form-control" style="width:min(135px, 100%); border:1px solid #d1d5db; color:#000;">
          <option value="0">Entire Spool</option>
          <option value="1">1.0 kg</option>
          <option value="2">0.5 kg</option>
          <option value="3">0.25 kg</option>
        </select>
      </div>

      <div class="form-grid" style="margin-top:5px;">
        <div></div>
        <label class="form-control"><input id="useFil" type="checkbox" checked> Use Filament Sensor</label>
      </div>

      <div class="form-grid" style="margin-top:8px;">
        <label for="jin" class="form-label">Completion Sound:</label>
        <select id="jin" class="form-control" style="width:min(110px, 100%); border:1px solid #d1d5db; color:#000;">
          <option value="0">Off</option>
          <option value="1">Simple</option>
          <option value="2">Glissando</option>
          <option value="3">Star Wars</option>
        </select>
      </div>

      <hr class="section-divider" style="margin:12px 0;">

      <!-- Servo (PRO boards) -->
      <div class="form-grid" style="margin-top:8px;">
        <label class="form-label">Servo Calibration:</label>
        <button id="servoCalBtn" class="mini-btn compact form-control">Calibrate</button>
      </div>

      <div class="form-grid" style="margin-top:8px;">
        <label class="form-label">Step Distance:</label>
        <div class="stepper form-control">
          <div class="stepper-seg" role="group" aria-label="Step distance controls">
            <button id="servoStepMinus" class="stepper-seg-btn" type="button" aria-label="Decrease step distance"><span class="stepper-glyph">−</span></button>
            <div class="stepper-seg-divider" aria-hidden="true"></div>
            <button id="servoStepPlus" class="stepper-seg-btn" type="button" aria-label="Increase step distance"><span class="stepper-glyph">+</span></button>
          </div>
          <span id="servoStepVal" class="stepper-value">1.75 mm</span>
        </div>
      </div>

      <div class="form-grid" style="margin-top:8px;">
        <label for="servoHomeSetting" class="form-label">Home Position:</label>
        <select id="servoHomeSetting" class="form-control" style="width:min(110px, 100%); border:1px solid #d1d5db; color:#000;">
          <option value="R">Right</option>
          <option value="L">Left</option>
        </select>
      </div>

      <hr class="section-divider" style="margin:12px 0;">

      <div class="form-grid" style="margin-top:8px;">
        <label for="motor" class="form-label">Motor Strength:</label>
        <div class="stepper form-control">
          <div class="stepper-seg" role="group" aria-label="Motor strength controls">
            <button id="motorMinus" class="stepper-seg-btn" type="button" aria-label="Decrease motor strength"><span class="stepper-glyph">−</span></button>
            <div class="stepper-seg-divider" aria-hidden="true"></div>
            <button id="motorPlus" class="stepper-seg-btn" type="button" aria-label="Increase motor strength"><span class="stepper-glyph">+</span></button>
          </div>
          <span id="motorVal" class="stepper-value">100 %</span>
        </div>
      </div>
      <div class="form-grid" style="margin-top:0px;">
        <div></div>
        <label class="form-control"><input id="dir" type="checkbox"> Change Direction</label>
      </div>
      <div class="form-grid" style="margin-top:2px;">
        <div></div>
        <label class="form-control"><input id="hs" type="checkbox"> High-Speed</label>
      </div>
      <div class="form-grid" style="margin-top:8px;">
        <label for="autoStop" class="form-label">Auto-Stop Sensitivity:</label>
        <select id="autoStop" class="form-control" style="width:min(110px, 100%); border:1px solid #d1d5db; color:#000;">
          <option value="0">Off</option>
          <option value="1">Low</option>
          <option value="2">Medium</option>
          <option value="3">High</option>
        </select>
      </div>

      <hr class="section-divider" style="margin:12px 0;">

      <div class="form-grid" style="margin-top:8px;">
        <label for="fan" class="form-label">Fan Speed:</label>
        <input id="fan" class="form-control" type="range" min="10" max="100" step="10" value="60" style="width:min(160px, 100%); margin-top:2px;">
      </div>
      <div class="form-grid" style="margin-top:0px;">
        <div></div>
        <label class="form-control"><input id="fanAlways" type="checkbox"> Fan Always On</label>
      </div>

      <hr class="section-divider" style="margin:12px 0;">

      <div class="form-grid" style="margin-top:8px;">
        <label class="form-label">Reference Time:</label>
        <div class="stepper form-control">
          <div class="stepper-seg" role="group" aria-label="Reference time controls">
            <button id="durMinus" class="stepper-seg-btn" type="button" aria-label="Decrease reference time"><span class="stepper-glyph">−</span></button>
            <div class="stepper-seg-divider" aria-hidden="true"></div>
            <button id="durPlus" class="stepper-seg-btn" type="button" aria-label="Increase reference time"><span class="stepper-glyph">+</span></button>
          </div>
          <span id="durVal" class="stepper-value">00m 00s</span>
        </div>
      </div>

      <!-- Speed slider moved to its own card -->
  </section>
  </div>

  </div>

  </div>

  <div style="text-align:center; margin-top:2rem; margin-bottom:2rem; font-size:1rem; color:rgb(var(--text)); width:100%;">
    Powered by <a href="https://developer.chrome.com/docs/capabilities/bluetooth" target="_blank" style="color:rgb(var(--text)); text-decoration:underline;">WebBluetooth</a>
    <div style="margin-top:0.6rem;">
      <a href="https://github.com/LukasT03" target="_blank" style="color:rgb(var(--text)); text-decoration:underline; margin-right:1rem;">GitHub</a>
      <a href="https://lts-design.com" target="_blank" style="color:rgb(var(--text)); text-decoration:underline;">lts-design.com</a>
    </div>
  </div>

  </div>

  <!-- Update / WiFi modal -->
  <div id="wifiModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Update and WiFi">
    <div class="modal">
      <button id="wifiModalClose" class="icon-btn modal-close" aria-label="Close">×</button>
      <div class="modal-header">
        <h2 class="modal-title">Update / WiFi</h2>
      </div>

      <section id="lts-update" class="section-base">

        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; width:100%;">
          <div style="font-size:1.1rem; font-weight:600;">WiFi</div>
          <button id="wifiScanBtn" class="mini-btn compact" type="button" style="justify-self:end;">Search Networks</button>
        </div>

        <div class="form-grid" style="margin-top:10px;">
          <label for="wifiSsid" class="form-label">Network:</label>
          <select id="wifiSsid" class="form-control" style="width:min(220px, 100%); border:1px solid #d1d5db; color:#000;">
            <option value="" selected>Select…</option>
          </select>
        </div>

        <div class="form-grid" style="margin-top:8px;">
          <label for="wifiPass" class="form-label">Password:</label>
          <input id="wifiPass" class="form-control" type="password" autocomplete="current-password" placeholder="WiFi password"
                 style="width:min(220px, 100%); border:1px solid #d1d5db; border-radius:10px; padding:0.45rem 0.6rem;" />
        </div>

        <div class="form-grid" style="margin-top:10px;">
          <div></div>
          <div class="form-control" style="display:flex; align-items:center; gap:10px;">
            <button id="wifiSendBtn" class="mini-btn compact" type="button">Send</button>
            <span id="wifiStatus" style="opacity:0.55; font-size:1.0rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 220px;">&nbsp;</span>
          </div>
        </div>

      </section>
    </div>
  </div>

  <!-- Servo calibration modal -->
  <div id="servoModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Servo calibration">
    <div class="modal">
      <button id="servoModalClose" class="icon-btn modal-close" aria-label="Close">×</button>
      <div class="modal-header">
        <h2 class="modal-title">Calibrate End Positions</h2>
      </div>

      <div id="servoSideSegment" class="segmented" role="tablist" aria-label="Calibration side">
        <div id="servoSideIndicator" class="seg-indicator"></div>
        <button id="servoSideL" class="seg-btn is-selected" type="button" role="tab" aria-selected="true">Left Side</button>
        <button id="servoSideR" class="seg-btn" type="button" role="tab" aria-selected="false">Right Side</button>
      </div>

      <hr class="section-divider" style="margin:12px 0;">

      <div class="cal-row">
        <button id="servoArrowLeft" class="arrow-btn" type="button" aria-label="Decrease angle">‹</button>
        <div id="servoAngleText" class="angle-text">Angle: –°</div>
        <button id="servoArrowRight" class="arrow-btn" type="button" aria-label="Increase angle">›</button>
      </div>

      <p class="cal-desc">Adjust the left and right end stops so that the filament guide just touches the sides.</p>
    </div>
  </div>

  <!-- BLE Manager -->
  <script src="webble-manager.js"></script>

  <!-- Block A Logic (leicht angepasst) -->
  <script>
  (() => {
    const ui = {
      connect:  document.getElementById('wbConnect'),
      connectWrap: document.getElementById('wbConnectWrap'),
      start:    document.getElementById('wbStart'),
      stop:     document.getElementById('wbStop'),
      prog:     document.getElementById('wbProg'),
      progBar:  document.getElementById('wbProgBar'),
      progPct:  document.getElementById('wbProgPct'),
      progRem:  document.getElementById('wbProgRem'),
      statusText: document.getElementById('wbStatusText'),
      buttons: document.getElementById('wbButtonGroup'),
      noSupport: document.getElementById('wbNoSupport'),
    };

    let statusHoldUntil = 0; // timestamp ms until which we force "Connected!"

    function setStatusTextAnimated(text, colorOrNull){
      const el = ui.statusText;
      if(!el) return;
      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const newColor = (colorOrNull === null) ? '' : colorOrNull;
      if (prefersReduced) { el.textContent = text; el.style.color = newColor; return; }
      if (el.textContent === text) { el.style.color = newColor; return; }
      el.style.transition = 'opacity 0.35s ease, transform 0.35s ease';
      el.style.opacity = '0';
      el.style.transform = 'scale(0.93)';
      setTimeout(() => {
        el.textContent = text;
        el.style.color = newColor;
        requestAnimationFrame(() => {
          el.style.opacity = '1';
          el.style.transform = 'scale(1)';
        });
      }, 120);
    }

    // Ensure initial percent text uses a space (e.g., "0 %") even before any JS updates
    if (ui.progPct) {
      const t = ui.progPct.textContent || '0';
      const n = parseInt(String(t).replace('%', '').trim(), 10);
      ui.progPct.textContent = (isNaN(n) ? 0 : n) + ' %';
    }

    function statusVisual(s){
      const code = (s && s.statusCode) ? String(s.statusCode).toUpperCase() : null;
      const txt  = (s && s.statusText) || null;
      const byFlags = s?.run ? {t:'Running…', c:'rgb(52,199,89)'} : (s && s.connected ? {t:'Connected', c:'rgb(52,199,89)'} : {t:'Not connected', c:''});
      if(!code) return { text: txt || byFlags.t, color: byFlags.c };
      switch(code){
        case 'R': return { text: txt || 'Running…',   color:'rgb(52,199,89)' };
        case 'P': return { text: txt || 'Paused',     color:'rgb(255,149,0)' };
        case 'U': return { text: txt || 'Updating…',  color:'rgb(14,122,254)' };
        case 'D': return { text: txt || 'Done!',      color:'rgb(52,199,89)' };
        case 'A': return { text: txt || 'Auto-Stop!', color:'rgb(254,56,60)' };
        case 'C': return { text: txt || 'Connected',  color:'rgb(52,199,89)' };
        case 'I': return { text: txt || 'Idle',       color:'rgb(52,199,89)' };
        default:  return { text: txt || byFlags.t,    color: byFlags.c };
      }
    }

    const isIOS = /iPad|iPhone|iPod|iOS/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isWebKit = /AppleWebKit/i.test(navigator.userAgent);
    const isIOSWebKit = isIOS && isWebKit;
    if (isIOSWebKit) {
      if (ui.buttons) ui.buttons.style.display = 'none';
      if (ui.connectWrap) ui.connectWrap.style.display = 'none';
      if (ui.noSupport) ui.noSupport.style.display = 'block';
      return;
    }
    if (ui.buttons) ui.buttons.style.display = 'block';
    if (ui.connectWrap) ui.connectWrap.style.display = 'block';
    if (ui.noSupport) ui.noSupport.style.display = 'none';
    const secure = (typeof window.isSecureContext === 'boolean') ? window.isSecureContext : (location.protocol === 'https:' || location.hostname === 'localhost');
    const hasBLE = !!(navigator.bluetooth && typeof navigator.bluetooth.requestDevice === 'function');
    const webBleSupported = hasBLE && secure && !isIOSWebKit;
    if(!webBleSupported){
      if(ui.buttons) ui.buttons.style.display = 'none';
      if (ui.connectWrap) ui.connectWrap.style.display = 'none';
      if(ui.noSupport) ui.noSupport.style.display = 'block';
      return;
    }

    function setConnected(on, justConnected){
      ui.stop.disabled  = !on;
      ui.start.disabled = !on;
      if (ui.connect) ui.connect.textContent = on ? 'Disconnect' : 'Connect Board';
      if (!on) { ui.start.textContent = 'Start'; }
      if(on && justConnected){
        statusHoldUntil = Date.now() + 1500;
      }
      if (ui.statusText) {
        if (on) {
          const withinHold = statusHoldUntil && Date.now() < statusHoldUntil;
          if (withinHold) {
            setStatusTextAnimated('Connected!', 'rgb(52,199,89)');
          } else {
            setStatusTextAnimated('Connected', '');
          }
        } else {
          setStatusTextAnimated('Not connected', '');
        }
      }
      if(!on && ui.progBar){ ui.progBar.style.width = '0%'; }
      if(!on && ui.progPct){ ui.progPct.textContent = '0 %'; }
    }

    if (ui.connect) {
      ui.connect.addEventListener('click', async () => {
        const st = window.webble.getState();
        if (st.connected) {
          window.webble.disconnect();
        } else {
          try { await window.webble.connect(); } catch(e) { alert(e.message||e); }
        }
      });
    }
    ui.start.addEventListener('click', () => {
      const label = (ui.start.textContent || '').trim();
      if (label === 'Pause') {
        window.webble.pause();
      } else {
        window.webble.start();
      }
    });
    ui.stop.addEventListener('click',  () => window.webble.stop());

    window.webble.on('connected',   () => {
      setConnected(true, true);
    });
    window.webble.on('disconnected',() => {
      statusHoldUntil = 0;
      setConnected(false);
    });
    window.webble.on('status', (s) => {
      const isConn = window.webble.getState().connected === true;
      const blockedByFil = !!s.useFil && !s.hasFilament;
      const isUpdating = (String(s.statusCode || s.code || '').toUpperCase() === 'U') || !!s.updating;
      ui.start.disabled = !isConn || blockedByFil || isUpdating;
      ui.stop.disabled  = !isConn || isUpdating;
      const isRunning = (String(s.statusCode || s.code || '').toUpperCase() === 'R') || !!s.run;
      ui.start.textContent = isRunning ? 'Pause' : 'Start';
      if (ui.progBar) {
        const p = Math.max(0, Math.min(100, Number(s.progress ?? s.PROG ?? 0)));
        ui.progBar.style.width = p + '%';

        const code = String(s.statusCode || s.code || '').toUpperCase();
        if (code === 'I') {
          ui.progBar.style.width = '0%';
        }
        if (code === 'D') {
          ui.progBar.style.background = 'rgb(52,199,89)';
        } else if (code === 'P') {
          ui.progBar.style.background = 'rgb(255,149,0)';
        } else if (code === 'A') {
          ui.progBar.style.background = 'rgb(254,56,60)';
        } else {
          ui.progBar.style.background = '#0c4c98';
        }
      }
      if (ui.progPct) {
        const pct = Math.round(Number(s.progress ?? s.PROG ?? 0));
        ui.progPct.textContent = pct + ' %';
      }
      if (ui.progRem) {
        let rem = s.remaining ?? null;
        if (typeof rem === 'number' && !isNaN(rem)) {
          const m = String(Math.floor(rem / 60)).padStart(2,'0');
          const sec = String(Math.floor(rem % 60)).padStart(2,'0');
          ui.progRem.textContent = `-${m}:${sec}`;
        }
      }
      const now = Date.now();
      if (ui.statusText && isConn && statusHoldUntil && now < statusHoldUntil) {
        setStatusTextAnimated('Connected!', 'rgb(52,199,89)');
      } else if (ui.statusText) {
        const vis = statusVisual({ ...s, connected: isConn });
        setStatusTextAnimated(vis.text, '');
      }
    });

    setConnected(window.webble.getState().connected);
    (function initProgress(){
      if(!ui.progBar || !window.webble?.getState) return;
      const st = window.webble.getState();
      const p = Math.max(0, Math.min(100, Number(st.progress ?? 0)));
      ui.progBar.style.width = p + '%';
      if(ui.progPct){
        const pct = Math.round(Number(st.progress ?? 0));
        ui.progPct.textContent = pct + ' %';
      }
      const isRunningInit = (String(st.statusCode || '').toUpperCase() === 'R') || !!st.run;
      ui.start.textContent = isRunningInit ? 'Pause' : 'Start';
      const isUpdatingInit = (String(st.statusCode || '').toUpperCase() === 'U') || !!st.updating;
      ui.start.disabled = !window.webble.getState?.().connected || isUpdatingInit || (!!st.useFil && !st.hasFilament);
      ui.stop.disabled  = !window.webble.getState?.().connected || isUpdatingInit;
      if(ui.progRem && typeof st.remaining === 'number'){
        const m = String(Math.floor(st.remaining/60)).padStart(2,'0');
        const sec = String(Math.floor(st.remaining%60)).padStart(2,'0');
        ui.progRem.textContent = `-${m}:${sec}`;
      }
      if(ui.statusText){
        const stc = window.webble.getState?.() || {};
        const vis = statusVisual(stc);
        setStatusTextAnimated(vis.text, '');
      }
    })();
  })();
  </script>

  <!-- Block B Logic (unverändert übernommen) -->
  <script>
  (() => {
    function whenWebbleReady(fn){
      if (window.webble && window.webble.__ready) { fn(); return; }
      const iv = setInterval(() => {
        if (window.webble && window.webble.__ready) { clearInterval(iv); fn(); }
      }, 50);
      setTimeout(() => clearInterval(iv), 5000);
    }

    // Info rendering removed

    // Info card meta (right of image)
    const infoBoard = document.getElementById('infoBoard');
    const infoRespooler = document.getElementById('infoRespooler');
    const infoFw = document.getElementById('infoFw');
    const infoWifi = document.getElementById('infoWifi');

    function inferBoardVersion(s){
      const name = String(s?.name || '').toLowerCase();
      if (name.includes('driver')) return 'Driver Board';
      if (name.includes('control')) return 'Control Board';
      return 'Unknown';
    }

    function mapRespoolerVersion(s){
      const v = String(s?.boardVariant || '').trim().toUpperCase();
      if (v === 'PRO') return 'Respooler Pro';
      if (v === 'STD') return 'Respooler V4';
      return 'Unknown';
    }

    function mapWifiStatus(s){
      const ok = (typeof s?.wifiConnected === 'boolean') ? s.wifiConnected : null;
      const ssid = (s?.wifiSSID != null && String(s.wifiSSID).trim().length) ? String(s.wifiSSID) : null;
      if (ok === true) return ssid ? ('Connected: ' + ssid) : 'Connected';
      if (ok === false) return 'Not connected';
      return '—';
    }

    function updateInfoMeta(s){
      const st = s || (window.webble?.getState ? window.webble.getState() : {});
      if (infoBoard) infoBoard.textContent = inferBoardVersion(st);
      if (infoRespooler) infoRespooler.textContent = mapRespoolerVersion(st);
      if (infoFw) infoFw.textContent = st?.fw ? String(st.fw) : '—';
      if (infoWifi) infoWifi.textContent = mapWifiStatus(st);
    }

    function bindWithWebble(){
      // WiFi / Update UI
      const wifiScanBtn  = document.getElementById('wifiScanBtn');
      const wifiSsid     = document.getElementById('wifiSsid');
      const wifiPass     = document.getElementById('wifiPass');
      const wifiSendBtn  = document.getElementById('wifiSendBtn');
      const wifiStatus   = document.getElementById('wifiStatus');

      const wifiModalBtn = document.getElementById('wifiModalBtn');
      const wifiModalBackdrop = document.getElementById('wifiModalBackdrop');
      const wifiModalClose = document.getElementById('wifiModalClose');

      function openWifiModal(){
        if (!wifiModalBackdrop) return;
        wifiModalBackdrop.classList.add('show');
      }
      function closeWifiModal(){
        if (!wifiModalBackdrop) return;
        wifiModalBackdrop.classList.remove('show');
      }

      if (wifiModalBtn) wifiModalBtn.addEventListener('click', openWifiModal);
      if (wifiModalClose) wifiModalClose.addEventListener('click', closeWifiModal);
      if (wifiModalBackdrop) {
        wifiModalBackdrop.addEventListener('click', (e) => {
          if (e.target === wifiModalBackdrop) closeWifiModal();
        });
      }
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeWifiModal();
      });

      // Status pills
      const pillConnSub = document.getElementById('pillConnSub');
      const pillFilSub  = document.getElementById('pillFilSub');
      const pillConnIcon = document.getElementById('pillConnIcon');
      const pillFilIcon  = document.getElementById('pillFilIcon');

      // Dark mode detection for icon variants
      const darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
      let isDarkMode = darkQuery.matches;
      darkQuery.addEventListener('change', e => {
        isDarkMode = e.matches;
        try { updateStatusPills(window.webble.getState()); } catch(_) {}
      });
      function setWifiStatusText(t){
        if (!wifiStatus) return;
        wifiStatus.textContent = (t && String(t).trim().length) ? String(t) : '\u00A0';
      }

      function populateSsids(ssids, selected){
        if (!wifiSsid) return;
        const cur = (selected != null) ? String(selected) : String(wifiSsid.value || '');
        const keep = cur;
        wifiSsid.innerHTML = '<option value="" ' + (keep ? '' : 'selected') + '>Select…</option>';
        (Array.isArray(ssids) ? ssids : []).forEach(s => {
          const v = String(s);
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          if (v === keep) opt.selected = true;
          wifiSsid.appendChild(opt);
        });
      }

      function updateStatusPills(s){
        try {
          const isConn = !!(s && s.connected);
          if (pillConnSub) pillConnSub.textContent = isConn ? 'Connected' : 'Disconnected';
          if (pillConnIcon) {
            pillConnIcon.src = isConn
              ? 'antenna.png'
              : (isDarkMode ? 'antenna-slash-dark.png' : 'antenna-slash.png');
          }

          // Filament: prefer hasFilament boolean if present; if not connected, default to Not Detected
          let has = null;
          if (s && typeof s.hasFilament === 'boolean') has = s.hasFilament;
          else if (s && typeof s.HAS_FIL === 'boolean') has = s.HAS_FIL;
          if (!isConn) has = false;

          if (pillFilSub) {
            if (has === true) pillFilSub.textContent = 'Detected';
            else pillFilSub.textContent = 'Not Detected';
          }
          if (pillFilIcon) {
            if (has === true) pillFilIcon.src = 'checkmark.png';
            else pillFilIcon.src = isDarkMode ? 'xmark-dark.png' : 'xmark.png';
          }
        } catch(_) {}
      }

      if (wifiScanBtn) {
        wifiScanBtn.addEventListener('click', async () => {
          try {
            setWifiStatusText('Scanning…');
            await window.webble.wifiScan();
          } catch(e) {
            setWifiStatusText('Scan failed');
            console.error(e);
          }
        });
      }

      if (wifiSsid) {
        wifiSsid.addEventListener('change', async (e) => {
          const ssid = String(e.target.value || '');
          if (!ssid) return;
          try {
            await window.webble.sendWiFiSSID(ssid);
            setWifiStatusText('SSID sent');
          } catch(err) {
            setWifiStatusText('SSID failed');
            console.error(err);
          }
        });
      }

      if (wifiSendBtn) {
        wifiSendBtn.addEventListener('click', async () => {
          const ssid = String(wifiSsid?.value || '').trim();
          const pass = String(wifiPass?.value || '');
          if (!ssid) { setWifiStatusText('Select a network'); return; }
          try {
            setWifiStatusText('Sending…');
            await window.webble.sendWiFiSSID(ssid);
            await window.webble.sendWiFiPassword(pass);
            await window.webble.wifiConnect();
            setWifiStatusText('Connecting…');
          } catch(e) {
            setWifiStatusText('Send failed');
            console.error(e);
          }
        });
      }

      // Update UI initially
      try {
        const w = window.webble.getWiFi?.();
        populateSsids(w?.ssids || [], w?.ssid || '');
        if (w?.connected && w?.ssid) setWifiStatusText('Connected: ' + w.ssid);
      } catch(_) {}
      const led = document.getElementById('led');
      const useFil = document.getElementById('useFil');
      const motorVal = document.getElementById('motorVal');
      const motorMinus = document.getElementById('motorMinus');
      const motorPlus  = document.getElementById('motorPlus');
      const dir = document.getElementById('dir');
      const hs = document.getElementById('hs');
      const autoStop = document.getElementById('autoStop');
      const jin = document.getElementById('jin');
      const wgt = document.getElementById('wgt');
      const fan = document.getElementById('fan');
      const fanAlways = document.getElementById('fanAlways');
      const speed = document.getElementById('speed');
      const speedVal = document.getElementById('speedVal');

      const durVal = document.getElementById('durVal');
      const durMinus = document.getElementById('durMinus');
      const durPlus  = document.getElementById('durPlus');

      // Servo UI
      const servoCalBtn = document.getElementById('servoCalBtn');
      const servoStepMinus = document.getElementById('servoStepMinus');
      const servoStepPlus  = document.getElementById('servoStepPlus');
      const servoStepVal   = document.getElementById('servoStepVal');

      // Modal
      const servoModalBackdrop = document.getElementById('servoModalBackdrop');
      const servoModalClose    = document.getElementById('servoModalClose');
      const servoSideL         = document.getElementById('servoSideL');
      const servoSideR         = document.getElementById('servoSideR');
      const servoArrowLeft     = document.getElementById('servoArrowLeft');
      const servoArrowRight    = document.getElementById('servoArrowRight');
      const servoAngleText     = document.getElementById('servoAngleText');
      const servoHomeSetting   = document.getElementById('servoHomeSetting');
      const servoSideSegment   = document.getElementById('servoSideSegment');
      const servoSideIndicator = document.getElementById('servoSideIndicator');

      const uiEditing = new Set();
      const beginUI = (key) => { uiEditing.add(key); try { window.webble.beginEdit(key); } catch(_){} };
      const endUI   = (key) => { uiEditing.delete(key); try { window.webble.commitEdit(key); } catch(_){} };
      const isUIEditing = (key) => uiEditing.has(key);

      const pending = new Map();
      function setPending(key, val, ms = 900) {
        pending.set(key, { val: String(val), until: Date.now() + ms });
      }
      function shouldApply(key, incomingVal) {
        const p = pending.get(key);
        if (!p) return true;
        if (Date.now() > p.until) { pending.delete(key); return true; }
        if (String(incomingVal) === p.val) { pending.delete(key); return true; }
        return false;
      }

      function bindSlider(el, key, setter, onLocal){
        el.addEventListener('pointerdown', () => beginUI(key));
        if (onLocal) el.addEventListener('input', e => onLocal(e.target.value));
        const commit = (v) => { setter(v); endUI(key); };
        el.addEventListener('pointerup',   e => commit(e.target.value));
        el.addEventListener('change',      e => commit(e.target.value));
        el.addEventListener('pointercancel', () => endUI(key));
        el.addEventListener('keyup', (e)=>{ if(e.key==='Enter' || e.key===' ') commit(e.target.value); });
      }
      function bindCheckbox(el, key, setter){
        el.addEventListener('pointerdown', () => beginUI(key));
        el.addEventListener('change', e => { setter(e.target.checked); endUI(key); });
        el.addEventListener('pointercancel', () => endUI(key));
        el.addEventListener('keyup', (e)=>{ if(e.key==='Enter' || e.key===' ') { setter(el.checked); endUI(key);} });
        el.addEventListener('blur', () => { if (uiEditing.has(key)) endUI(key); });
      }
      function bindSelect(el, key, setter){
        el.addEventListener('pointerdown', () => beginUI(key));
        el.addEventListener('focusin',   () => beginUI(key));
        el.addEventListener('change',    e => { setter(e.target.value); endUI(key); });
        el.addEventListener('blur',      () => { if (uiEditing.has(key)) endUI(key); });
      }

      bindSlider(led,   'LED',     (v)=>window.webble.setLED(v));
      bindCheckbox(useFil,'USE_FIL',(on)=>window.webble.setUseFil(on));
      // Motor stepper logic replaces slider binding
      bindCheckbox(dir, 'DIR',     (on)=>window.webble.setDir(on));
      bindCheckbox(hs,  'HS',      (on)=>window.webble.setHighSpeed(on));
      bindSelect(autoStop, 'TRQ', (v) => { setPending('TRQ', v); window.webble.setTorque(v); });
      bindSelect(jin,      'JIN', (v) => { setPending('JIN', v); window.webble.setJingle(v); });
      bindSelect(wgt,      'WGT', (v) => { setPending('WGT', v); window.webble.setTargetWeight(v); });
      // Servo home position
      if (servoHomeSetting) {
        bindSelect(servoHomeSetting, 'SV_HOME', (v) => {
          setPending('SV_HOME', v);
          window.webble.setServoHome(v);
        });
      }
      bindSlider(fan,   'FAN_SPD', (v)=>window.webble.setFanSpeed(v));
      bindCheckbox(fanAlways,'FAN_ALW',(on)=>window.webble.setFanAlways(on));
      bindSlider(speed, 'SPD',     (v)=>window.webble.setSpeed(v), (v)=>{ speedVal.textContent = v + ' %'; });
      // Motor strength +/- buttons
      let motorLocal = 100;
      function clampPow(v){
        v = Number(v);
        if (!Number.isFinite(v)) return 100;
        return Math.max(80, Math.min(120, Math.round(v / 10) * 10));
      }
      function updateMotorUI(){
        if (motorVal) motorVal.textContent = String(motorLocal) + ' %';
      }
      function commitMotor(){
        beginUI('POW');
        window.webble.setPower(motorLocal);
        endUI('POW');
      }
      updateMotorUI();

      if (motorMinus) motorMinus.addEventListener('click', () => {
        motorLocal = clampPow(motorLocal - 10);
        updateMotorUI();
        commitMotor();
      });
      if (motorPlus) motorPlus.addEventListener('click', () => {
        motorLocal = clampPow(motorLocal + 10);
        updateMotorUI();
        commitMotor();
      });

      // Reference Time (calibration time at 80) — DUR in seconds
      let durLocal = 895;
      function clampDur(v){
        v = Number(v);
        if (!Number.isFinite(v)) return 895;
        v = Math.round(v);
        return Math.max(10, Math.min(60 * 180, v)); // 10s .. 180m
      }
      function fmtDur(sec){
        const s = clampDur(sec);
        const m = Math.floor(s / 60);
        const r = s % 60;
        return String(m).padStart(2,'0') + 'm ' + String(r).padStart(2,'0') + 's';
      }
      function updateDurUI(){
        if (durVal) durVal.textContent = fmtDur(durLocal);
      }
      function commitDur(){
        beginUI('DUR');
        setPending('DUR', durLocal);
        window.webble.setDurationAt80(durLocal);
        endUI('DUR');
      }
      updateDurUI();

      const durDelta = 5; // seconds per click
      if (durMinus) durMinus.addEventListener('click', () => {
        durLocal = clampDur(durLocal - durDelta);
        updateDurUI();
        commitDur();
      });
      if (durPlus) durPlus.addEventListener('click', () => {
        durLocal = clampDur(durLocal + durDelta);
        updateDurUI();
        commitDur();
      });

      function fmtMm(v){
        const n = Number(v);
        if (!Number.isFinite(n)) return '– mm';
        return n.toFixed(2) + ' mm';
      }

      function openServoModal(){
        if (!servoModalBackdrop) return;

        // When opening, align modal picker with current Home Position
        try {
          const hv = (servoHomeSetting && servoHomeSetting.value)
            ? String(servoHomeSetting.value).trim().toUpperCase()
            : null;
          if (hv === 'R' || hv === 'L') {
            setSide(hv);
          }
        } catch(_) {}

        servoModalBackdrop.classList.add('show');
      }
      function closeServoModal(){
        if (!servoModalBackdrop) return;
        servoModalBackdrop.classList.remove('show');

        // When closing, return servo to Home position
        try {
          if (window.webble && typeof window.webble.servoGoto === 'function') {
            window.webble.servoGoto('HOME');
          }
        } catch(_) {}
      }

      if (servoCalBtn) {
        servoCalBtn.addEventListener('click', () => openServoModal());
      }
      if (servoModalClose) servoModalClose.addEventListener('click', closeServoModal);
      if (servoModalBackdrop) {
        servoModalBackdrop.addEventListener('click', (e) => {
          if (e.target === servoModalBackdrop) closeServoModal();
        });
      }
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeServoModal();
      });

      // Step distance +/- buttons
      let servoStepLocal = 1.75;
      function updateServoStepUI(){
        if (servoStepVal) servoStepVal.textContent = fmtMm(servoStepLocal);
      }
      updateServoStepUI();

      const stepDelta = 0.01;
      const stepMin = 0.05;
      const stepMax = 20.0;

      function commitServoStep(){
        try { beginUI('SV_STP'); } catch(_){}
        window.webble.setServoStepMm(servoStepLocal);
        try { endUI('SV_STP'); } catch(_){}
      }

      if (servoStepMinus) servoStepMinus.addEventListener('click', () => {
        servoStepLocal = Math.max(stepMin, +(servoStepLocal - stepDelta).toFixed(2));
        updateServoStepUI();
        commitServoStep();
      });
      if (servoStepPlus) servoStepPlus.addEventListener('click', () => {
        servoStepLocal = Math.min(stepMax, +(servoStepLocal + stepDelta).toFixed(2));
        updateServoStepUI();
        commitServoStep();
      });

      // Servo calibration (segmented + arrows)
      let calSide = 'L'; // 'L' or 'R'
      let angleL = 175;
      let angleR = 5;

      function setSide(side){
        calSide = (side === 'R') ? 'R' : 'L';

        // Side selection should also move the servo to that side
        try {
          if (window.webble && typeof window.webble.servoGoto === 'function') {
            window.webble.servoGoto(calSide);
          }
        } catch(_) {}

        if (servoSideL) {
          const on = calSide === 'L';
          servoSideL.classList.toggle('is-selected', on);
          servoSideL.setAttribute('aria-selected', on ? 'true' : 'false');
        }
        if (servoSideR) {
          const on = calSide === 'R';
          servoSideR.classList.toggle('is-selected', on);
          servoSideR.setAttribute('aria-selected', on ? 'true' : 'false');
        }

        if (servoSideIndicator) {
          const index = (calSide === 'L') ? 0 : 1;
          servoSideIndicator.style.transform = `translateX(${index * 100}%)`;
        }

        updateAngleText();
      }

      function updateAngleText(){
        const v = (calSide === 'L') ? angleL : angleR;
        if (servoAngleText) servoAngleText.textContent = `Angle: ${Math.round(v)}°`;
      }

      function commitAngle(){
        if (calSide === 'L') {
          beginUI('SV_L');
          window.webble.setServoAngleL(angleL);
          endUI('SV_L');
        } else {
          beginUI('SV_R');
          window.webble.setServoAngleR(angleR);
          endUI('SV_R');
        }
      }

      function nudgeAngle(delta){
        if (calSide === 'L') {
          angleL = Math.max(0, Math.min(180, Math.round(angleL + delta)));
        } else {
          angleR = Math.max(0, Math.min(180, Math.round(angleR + delta)));
        }
        updateAngleText();
        commitAngle();
      }

      if (servoSideL) servoSideL.addEventListener('click', () => setSide('L'));
      if (servoSideR) servoSideR.addEventListener('click', () => setSide('R'));
      if (servoArrowLeft)  servoArrowLeft.addEventListener('click', () => nudgeAngle(+1));
      if (servoArrowRight) servoArrowRight.addEventListener('click', () => nudgeAngle(-1));

      // Initialize
      setSide('L');

      window.webble.on('status', s => {
        updateInfoMeta(s);
        updateStatusPills(s);
        // WiFi / Update card
        try {
          const isConn = window.webble.getState().connected === true;
          const scanning = !!s.isScanningForSSIDs;
          if (wifiScanBtn) wifiScanBtn.disabled = !isConn || scanning;
          if (wifiSsid) wifiSsid.disabled = !isConn || scanning;
          if (wifiPass) wifiPass.disabled = !isConn;
          if (wifiSendBtn) wifiSendBtn.disabled = !isConn || scanning;
          if (wifiModalBtn) wifiModalBtn.disabled = !isConn;

          if (Array.isArray(s.availableSSIDs)) {
            populateSsids(s.availableSSIDs, s.wifiSSID || '');
          }

          if (scanning) {
            setWifiStatusText('Scanning…');
          } else if (s.wifiConnected) {
            setWifiStatusText(s.wifiSSID ? ('Connected: ' + s.wifiSSID) : 'Connected');
          } else if (s.wifiConnectionResult != null) {
            setWifiStatusText(s.wifiConnectionResult ? 'Connected' : 'Connection failed');
          } else if (s.wifiLastResult != null) {
            setWifiStatusText(s.wifiLastResult ? 'OK' : 'Failed');
          }
        } catch(_) {}
        if (!isUIEditing('LED'))      led.value = s.led ?? 50;
        if (!isUIEditing('USE_FIL'))  useFil.checked = (s.useFil !== false);
        if (!isUIEditing('POW')) {
          motorLocal = clampPow(s.pow ?? 100);
          updateMotorUI();
        }
        if (!isUIEditing('DIR'))      dir.checked = !!s.dir;
        if (!isUIEditing('HS'))       hs.checked = !!s.hs;
        if (!isUIEditing('TRQ')) { const v = String(s.trq ?? 0); if (shouldApply('TRQ', v)) autoStop.value = v; }
        if (!isUIEditing('JIN')) { const v = String(s.jin ?? 0); if (shouldApply('JIN', v)) jin.value = v; }
        if (!isUIEditing('WGT')) { const v = String(s.targetWeight ?? s.wgt ?? s.WGT ?? s.targetweight ?? 0); if (shouldApply('WGT', v)) wgt.value = v; }
        if (!isUIEditing('FAN_SPD'))  fan.value = s.fan ?? 80;
        if (!isUIEditing('FAN_ALW'))  fanAlways.checked = !!s.fanAlways;
        if (!isUIEditing('SPD'))      { speed.value = s.speed ?? 80; speedVal.textContent = (s.speed ?? 80) + ' %'; }
        if (!isUIEditing('DUR')) {
          const v = Number(s.dur ?? s.DUR);
          if (Number.isFinite(v)) {
            const vv = clampDur(v);
            if (shouldApply('DUR', vv)) {
              durLocal = vv;
              updateDurUI();
            }
          }
        }

        // Servo values
        if (!isUIEditing('SV_STP')) {
          const v = Number(s.servoStepMm ?? s.SV_STP);
          if (Number.isFinite(v)) {
            servoStepLocal = v;
            updateServoStepUI();
          }
        }
        if (!isUIEditing('SV_L') && typeof (s.servoAngleL ?? s.SV_L) === 'number') {
          angleL = Math.max(0, Math.min(180, Math.round(Number(s.servoAngleL ?? s.SV_L))));
          if (calSide === 'L') updateAngleText();
        }
        if (!isUIEditing('SV_R') && typeof (s.servoAngleR ?? s.SV_R) === 'number') {
          angleR = Math.max(0, Math.min(180, Math.round(Number(s.servoAngleR ?? s.SV_R))));
          if (calSide === 'R') updateAngleText();
        }
        if (!isUIEditing('SV_HOME') && servoHomeSetting && typeof (s.servoHome ?? s.SV_HOME) === 'string') {
          const h = String(s.servoHome ?? s.SV_HOME).trim().toUpperCase();
          if ((h === 'R' || h === 'L') && shouldApply('SV_HOME', h)) {
            servoHomeSetting.value = h;
          }
        }

        // Disable servo controls when not connected
        const isConn = window.webble.getState().connected === true;
        if (servoCalBtn) servoCalBtn.disabled = !isConn;
        if (servoStepMinus) servoStepMinus.disabled = !isConn;
        if (servoStepPlus) servoStepPlus.disabled = !isConn;
        if (servoSideL) servoSideL.disabled = !isConn;
        if (servoSideR) servoSideR.disabled = !isConn;
        if (servoArrowLeft)  servoArrowLeft.disabled = !isConn;
        if (servoArrowRight) servoArrowRight.disabled = !isConn;
        if (servoHomeSetting) servoHomeSetting.disabled = !isConn;
        if (motorMinus) motorMinus.disabled = !isConn;
        if (motorPlus)  motorPlus.disabled = !isConn;
        if (durMinus) durMinus.disabled = !isConn;
        if (durPlus)  durPlus.disabled = !isConn;
        if (servoSideSegment) servoSideSegment.classList.toggle('is-disabled', !isConn);
      });

      try {
        const initial = window.webble.getState();
        updateStatusPills(initial);
        updateInfoMeta(initial);

        // Initialize servo UI
        if (typeof initial.servoStepMm === 'number') {
          servoStepLocal = initial.servoStepMm;
          updateServoStepUI();
        }
        if (typeof initial.servoAngleL === 'number') angleL = Math.max(0, Math.min(180, Math.round(initial.servoAngleL)));
        if (typeof initial.servoAngleR === 'number') angleR = Math.max(0, Math.min(180, Math.round(initial.servoAngleR)));
        updateAngleText();
        if (servoHomeSetting && typeof initial.servoHome === 'string') {
          const h = String(initial.servoHome).trim().toUpperCase();
          if (h === 'R' || h === 'L') servoHomeSetting.value = h;
        }
        // Initialize motor stepper UI
        if (typeof initial.pow === 'number') {
          motorLocal = clampPow(initial.pow);
          updateMotorUI();
        }
        // Initialize reference time UI
        if (typeof initial.dur === 'number') {
          durLocal = clampDur(initial.dur);
          updateDurUI();
        }
      } catch(_) {}
    }

    // Info button and popup handlers removed

    whenWebbleReady(bindWithWebble);
  })();
  </script>
</body>
</html>