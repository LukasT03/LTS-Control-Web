<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LTS Web Control</title>
  <link rel="icon" type="image/png" href="/LogoFavicon.png" />

  <style>
    :root {
      /* Basis wie beim Web Flasher */
      --bg: 242 242 247;
      --text: 17 17 17;
      --accent: #0E7AFE;
      --accent-dark: #1364C4;

      /* Für die alten Shopify-Blöcke A/B */
      --flasher-bg: 255 255 255;
      --flasher-text: 17 17 17;
      --background-secondary: 255 255 255;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: 15 17 21;
        --text: 234 234 234;

        --flasher-bg: 28 28 30;
        --flasher-text: 234 234 234;
        --background-secondary: 44 44 46;
      }
    }

    body {
      margin: 0;
      background: rgb(var(--bg));
      color: rgb(var(--text));
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      padding: 1rem;
      line-height: 1.3;
      max-width: 1100px;
      margin-inline: auto;
      padding-top: 7vh;
      min-height: 10vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    button {
      -webkit-tap-highlight-color: transparent;
      font-family: inherit;
    }

    .header {
      width: 100%;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 0.8rem;
      flex-wrap: nowrap;
    }

    .header-image img {
      height: auto;
      width: auto;
      max-height: 96px;
      max-width: 140px;
      display: block;
    }

    .header-text {
      margin-top: 0;
      text-align: left;
    }

    h1 {
      margin-top: 0rem;
      margin-bottom: 0.2rem;
      font-size: 2rem;
      text-align: left;
      white-space: nowrap;
    }

    .subtitle {
      font-size: 1.1rem;
    }

    /* Top status pills (UI only) */
    .status-pills {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      justify-content: stretch;
      gap: 14px;
      margin-top: 0;
      margin-bottom: 0;
    }

    .status-pill {
      background: #ffffff;
      border-radius: 28px; /* match card border radius */
      padding: 0 16px;
      height: 56px;
      min-height: 56px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    @media (prefers-color-scheme: dark) {
      .status-pill {
        background: rgb(28,28,30);
      }
    }

    @media (prefers-color-scheme: dark) {
      #lts-update select,
      #lts-update input[type="password"],
      #lts-update input[type="text"] {
        background: rgba(255,255,255,0.08);
        color: rgb(var(--text));
        border-color: rgba(255,255,255,0.18);
      }
    }

    .status-pill svg {
      width: 28px;
      height: 28px;
      flex: 0 0 28px;
      color: rgb(var(--text));
      opacity: 0.95;
    }
    .status-emoji {
      font-size: 1.6rem;
      line-height: 1;
      flex: 0 0 auto;
    }

    .status-pill-text {
      display: flex;
      flex-direction: column;
      line-height: 1.05;
      min-width: 0;
    }

    .status-pill-title {
      font-size: 1.1rem;      /* match .lts-btn */
      font-weight: 600;       /* match .lts-btn */
      letter-spacing: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-pill-subtitle {
      margin-top: 4px;
      font-size: 1.1rem;      /* match settings card text */
      font-weight: 400;
      opacity: 0.45;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 450px) {
      .status-pill svg {
        width: 24px;
        height: 24px;
        flex-basis: 24px;
      }
      .status-pill-title,
      .status-pill-subtitle {
        font-size: 1.0rem;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 28px;
      padding: 1rem;
      margin-top: 0;
    }

    /* Slightly tighter top padding for the Control card */
    .card.control-card {
      padding-top: 0.6rem;
    }

    @media (prefers-color-scheme: dark) {
      .card {
        background: rgb(28,28,30);
      }
    }

    /* Pill-style card (e.g. Speed) */
    .card.pill-card {
      padding: 0 16px;
      height: 56px;
      min-height: 56px;
      display: flex;
      align-items: center;
    }


    /* Two-column layout for Control + Settings cards */
    .cards-row {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem; /* spacing below the status pills */
      align-items: start;
    }

    /* Stack multiple cards inside the left column (Control + Speed) */
    .card-stack {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
    }

    @media (max-width: 870px) {
      .cards-row {
        grid-template-columns: 1fr;
      }
    }

    /* Web Flasher Button-Style */
    .lts-btn {
      padding: 0.85rem 1.5rem;
      border-radius: 14px;
      background-color: #1a1a1a;
      color: #fff !important;
      border: none;
      font-size: 1.1rem;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .lts-btn:disabled {
      background-color: #1a1a1a;
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Spezifische Farben für Control-Buttons (Block A) */
    #wbConnect, #wbConnect:hover, #wbConnect:active, #wbConnect[disabled] {
      background:#0E7AFE !important;
      color:#ffffff !important;
      border:none !important;
      box-shadow:none !important;
      -webkit-appearance:none;
      appearance:none;
    }

    #wbStart, #wbStart:hover, #wbStart:active, #wbStart[disabled] {
      background:#d1e9ff !important;
      color:#0088fe !important;
      border:none !important;
      box-shadow:none !important;
      -webkit-appearance:none;
      appearance:none;
    }
    @media (prefers-color-scheme: dark) {
      #wbStart, #wbStart:hover, #wbStart:active, #wbStart[disabled] {
        background:#153a56 !important;
      }
    }

    #wbStop, #wbStop:hover, #wbStop:active, #wbStop[disabled] {
      background:#ffdbdc !important;
      color:#fe383c !important;
      border:none !important;
      box-shadow:none !important;
      -webkit-appearance:none;
      appearance:none;
    }
    @media (prefers-color-scheme: dark) {
      #wbStop, #wbStop:hover, #wbStop:active, #wbStop[disabled] {
        background:#492326 !important;
      }
    }

    /* Progress bar (Block A, leicht angepasst) */
    #wbProg {
      width:100%;
      height:14px;
      background:#e5e7eb;
      border-radius:9999px;
      overflow:hidden;
      margin:10px 0 12px 0;
    }
    @media (prefers-color-scheme: dark) {
      #wbProg {
        background: rgba(255,255,255,0.08);
      }
    }
    .section-divider {
      border: 0;
      border-top: 1px solid #d1d5db;
    }

    @media (prefers-color-scheme: dark) {
      .section-divider {
        border-top-color: rgba(255,255,255,0.18);
      }
    }
    #wbProgBar {
      height:100%;
      width:0%;
      background:#0c4c98;
      transition: width 0.35s ease, background-color 0.35s ease, background 0.35s ease;
      will-change: width, background-color;
    }
    @media (prefers-reduced-motion: reduce) {
      #wbProgBar { transition: none; }
    }

    #wbStatusText {
      display:inline-block;
      will-change: opacity, transform;
    }
    #wbProgPct,
    #wbStatusText,
    #wbProgRem {
      font-size: 1.1rem;
    }
    @media (prefers-reduced-motion: reduce) {
      #wbStatusText { transition: none !important; }
    }

    /* Block B – zusätzliche Styles */
    /* Typography for settings card (match Web Flasher sizing) */
    #lts-settings label,
    #lts-settings select,
    #lts-settings input[type="range"],
    #lts-settings input[type="checkbox"],
    #lts-settings span,
    #lts-settings #speedVal {
      font-size: 1.1rem;
    }
    /* Typography for speed card (match settings card sizing) */
    #lts-speed label,
    #lts-speed input[type="range"],
    #lts-speed span,
    #lts-speed #speedVal {
      font-size: 1.1rem;
    }
    /* Custom accent color for sliders and checkmarks */
    input[type="range"],
    input[type="checkbox"] {
      accent-color: #1364C4;
    }
    @media (prefers-color-scheme: dark) {
      input[type="range"],
      input[type="checkbox"] {
        accent-color: #1364C4;
      }
    }

    /* Kleine Typo-Anpassungen für schmale Screens */
    @media (max-width: 450px) {
      h1 {
        font-size: 1.9rem;
      }
      .header-image img {
        max-width: 100px;
        max-height: 80px;
      }
      .subtitle {
        font-size: 1.0rem;
      }
      .lts-btn {
        font-size: 1.0rem;
      }
      #wbProgPct,
      #wbStatusText,
      #wbProgRem {
        font-size: 1.0rem;
      }
      #lts-settings label,
      #lts-settings select,
      #lts-settings input[type="range"],
      #lts-settings input[type="checkbox"],
      #lts-settings span,
      #lts-settings #speedVal {
        font-size: 1.0rem;
      }
      #lts-speed label,
      #lts-speed input[type="range"],
      #lts-speed span,
      #lts-speed #speedVal {
        font-size: 1.0rem;
      }
      .header {
        gap: 12px;
        justify-content: flex-start;
      }
      .header-text {
        text-align: left;
      }
    }

    /* --- Servo calibration modal --- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 9999;
    }
    .modal-backdrop.show { display: flex; }

    .modal {
      width: min(480px, 100%);
      background: #ffffff;
      border-radius: 31px;
      padding: 1rem;
      box-shadow: 0 18px 50px rgba(0,0,0,0.22);
      border: 1px solid #d1d5db; /* match section divider color */
      position: relative;
    }
    @media (prefers-color-scheme: dark) {
      .modal {
        background: rgb(28,28,30);
        border: 1px solid rgba(255,255,255,0.18); /* match dark divider color */
      }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 0.75rem;
      position: relative;
      padding-right: 44px;   /* reserve space for the close button */
    }
    .modal-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 0;
      line-height: 30px; /* match close button height for exact vertical centering */
    }

    .icon-btn {
      border: none;
      background: #e5e7eb; /* match grey buttons */
      color: rgb(var(--text));
      font-size: 1.7rem;
      width: 30px;
      height: 30px;
      padding-bottom: 6px;
      border-radius: 9999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    @media (prefers-color-scheme: dark) {
      .icon-btn {
        background: rgba(255,255,255,0.14);
      }
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      transform: none;
      z-index: 20;           /* ensure it stays above modal header/contents */
      pointer-events: auto;  /* ensure it can receive clicks */
    }

    .mini-btn {
      border: none;
      border-radius: 12px;
      padding: 0.55rem 0.75rem;
      font-size: 1.0rem;
      font-weight: 600;
      cursor: pointer;
      background: #e5e7eb; /* match segmented picker background */
      color: rgb(var(--text));
      -webkit-appearance: none;
      appearance: none;
    }

    /* Compact mini button for text-only actions (e.g. Calibrate) */
    .mini-btn.compact {
      height: 34px;              /* match +/- buttons visual height */
      padding: 0 0.75rem;        /* no vertical padding */
      border-radius: 10px;       /* match +/- buttons */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: auto;               /* shrink to fit content */
      min-width: 0;
      white-space: nowrap;
    }
    @media (prefers-color-scheme: dark) {
      .mini-btn { background: rgba(255,255,255,0.14); }
    }
    .mini-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .stepper {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      justify-self: start;
    }
    .stepper .mini-btn { width: 36px; padding: 0.30rem 0; border-radius: 10px; }
    .stepper .stepper-glyph {
      display: inline-block;
      position: relative;
      top: -1px; /* adjust this value (+/- px) to move the glyph */
    }
    .stepper-value {
      min-width: 70px;
      text-align: center;
      font-variant-numeric: tabular-nums;
      font-size: 1.05rem;
    }

    .modal .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      align-items: center;
      column-gap: 0px;
      width: 100%;
      margin: 0;
      margin-top: 10px;
    }
    .modal .row label { text-align: right; padding-right: 12px; }
    .modal .row input[type="range"] { width: min(260px, 100%); justify-self: start; }

    .segmented {
      display: flex;
      padding: 0.2rem;
      background: #e5e7eb;
      border-radius: 14px;
      width: 100%;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      margin-top: 0;
    }

    .segmented.is-disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    @media (prefers-color-scheme: dark) {
      .segmented {
        background: rgba(255,255,255,0.08);
      }
    }

    .seg-indicator {
      position: absolute;
      top: 0.25rem;
      left: 0.25rem;
      height: calc(100% - 0.5rem);
      width: calc(50% - 0.25rem);
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      transform: translateX(0%);
      transition: transform 0.25s ease;
      pointer-events: none;
    }
    @media (prefers-color-scheme: dark) {
      .seg-indicator {
        background: rgba(255,255,255,0.14);
      }
    }

    .seg-btn {
      flex: 1 1 0;
      padding: 0.4rem 0.9rem;
      border: none;
      background: transparent;
      font-size: 1.1rem;
      font-weight: 400;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      position: relative;
      color: rgb(var(--text));
      transition: background 0.25s ease, box-shadow 0.25s ease;
      -webkit-appearance: none;
      appearance: none;
    }
    .seg-btn.is-selected {
      font-weight: 600; /* selected state emphasis, matches Web Flasher */
    }
    .seg-btn:focus {
      outline: none;
    }

    .cal-row {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 64px 1fr 64px;
      align-items: center;
      gap: 12px;
    }
    .arrow-btn {
      border: none;
      border-radius: 10px;
      height: 52px;
      width: 64px;
      cursor: pointer;
      background: #e5e7eb; /* match segmented picker background */
      color: rgb(var(--text));
      -webkit-appearance: none;
      appearance: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      line-height: 1;
    }
    @media (prefers-color-scheme: dark) {
      .arrow-btn { background: rgba(255,255,255,0.14); }
    }
    .angle-text {
      text-align: center;
      font-size: 1.1rem;           /* match settings card text */
      font-weight: 400;            /* match settings card text */
      opacity: 1;                  /* same visual weight as settings */
      font-variant-numeric: tabular-nums;
    }
    .cal-desc {
      margin: 16px 0 0 0;
      opacity: 0.55;
      font-size: 1.05rem;
      line-height: 1.25;
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-image">
      <img src="Logo.png" alt="Logo" />
    </div>
    <div class="header-text">
      <h1>Web Control</h1>
      <div class="subtitle">Control your LTS Respooler</div>
    </div>
  </div>

  <!-- TOP STATUS PILLS moved to right column above Settings card -->

  <div class="cards-row">

  <div class="card-stack">
  <!-- CONTROL CARD (Block A) -->
  <div class="card control-card">
    <section id="lts-control" style="display:block;width:100%;max-width:none;margin:0;padding-bottom:0;line-height:1.5;font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;color: rgb(var(--flasher-text));border-radius:18px;background:transparent;">
      <p style="visibility:hidden; font-size:20px; line-height:1px; margin:0; padding:0;">---------------------------------------------------------------------</p>
      <div style="display:grid; grid-template-columns:1fr auto 1fr; align-items:center; margin:0 0 0 0;">
        <span id="wbProgPct" style="justify-self:start;">0 %</span>
        <span id="wbStatusText" style="justify-self:center;">Not connected</span>
        <span id="wbProgRem" style="justify-self:end;">-00:00</span>
      </div>
      <div id="wbProg">
        <div id="wbProgBar"></div>
      </div>
      <div id="wbButtonGroup" style="display:none">
        <div class="lts-actions" style="display:flex;flex-wrap:nowrap;gap:12px;width:100%;align-items:stretch;margin:16px 0 0 0;">
          <button id="wbConnect" class="lts-btn" style="flex:1 0 0;min-width:0;max-width:none;width:100%;">Connect</button>
          <button id="wbStart"   class="lts-btn" style="flex:1 0 0;min-width:0;max-width:none;width:100%;" disabled>Start</button>
          <button id="wbStop"    class="lts-btn" style="flex:1 0 0;min-width:0;max-width:none;width:100%;" disabled>Stop</button>
        </div>
      </div>
      <div id="wbNoSupport" style="display:block; text-align:center; margin:16px 0 0 0; color:#ff8c28;">
        WebBluetooth is not supported in this browser. Please use Chrome or Edge on desktop or Android, or download the iOS app.
      </div>
    </section>
  </div>

  <!-- SPEED CARD -->
  <div class="card pill-card">
    <section id="lts-speed"
      style="display:block;
             width:100%;
             margin:0;
             line-height:1.5;
             font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;
             color:rgb(var(--flasher-text));">

      <div style="display:grid; grid-template-columns:max-content 1fr max-content; align-items:center; column-gap:12px; width:100%; margin:0;">
        <label for="speed">Speed:</label>
        <input id="speed" type="range" min="50" max="100" step="1" value="85" style="width:100%;">
        <span id="speedVal" style="display:inline-block; width:6ch; text-align:right;">85 %</span>
      </div>
    </section>
  </div>

  <!-- UPDATE CARD (WiFi) -->
  <div class="card">
    <section id="lts-update"
      style="display:block;
             width:100%;
             margin:0;
             line-height:1.5;
             font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;
             color:rgb(var(--flasher-text));">

      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; width:100%;">
        <div style="font-size:1.1rem; font-weight:600;">Update</div>
        <button id="wifiScanBtn" class="mini-btn compact" type="button" style="justify-self:end;">Search Networks</button>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:10px;">
        <label for="wifiSsid" style="text-align:right; padding-right:12px;">Network:</label>
        <select id="wifiSsid" style="justify-self:start; width:min(220px, 100%); border:1px solid #d1d5db; color:#000;">
          <option value="" selected>Select…</option>
        </select>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:8px;">
        <label for="wifiPass" style="text-align:right; padding-right:12px;">Password:</label>
        <input id="wifiPass" type="password" autocomplete="current-password" placeholder="WiFi password"
               style="justify-self:start; width:min(220px, 100%); border:1px solid #d1d5db; border-radius:10px; padding:0.45rem 0.6rem;" />
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:10px;">
        <div></div>
        <div style="display:flex; align-items:center; gap:10px; justify-self:start;">
          <button id="wifiSendBtn" class="mini-btn compact" type="button">Send</button>
          <span id="wifiStatus" style="opacity:0.55; font-size:1.0rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 220px;">&nbsp;</span>
        </div>
      </div>

    </section>
  </div>

  </div>

    <div class="card-stack">

    <!-- TOP STATUS PILLS (UI only) -->
    <div class="status-pills" aria-label="Status">
      <div class="status-pill">
        <img id="pillConnIcon" src="antenna-slash.png" alt="Connection" width="30" height="30" style="flex:0 0 30px;">
        <div class="status-pill-text">
          <div class="status-pill-title">Connection</div>
          <div id="pillConnSub" class="status-pill-subtitle">Disconnected</div>
        </div>
      </div>

      <div class="status-pill">
        <img id="pillFilIcon" src="xmark.png" alt="Filament" width="30" height="30" style="flex:0 0 30px;">
        <div class="status-pill-text">
          <div class="status-pill-title">Filament</div>
          <div id="pillFilSub" class="status-pill-subtitle">Not Detected</div>
        </div>
      </div>
    </div>


    <!-- SETTINGS CARD (Block B) -->
    <div class="card">
      <section id="lts-settings" 
        style="display:block;
               width:100%;
               margin:0;
               line-height:1.5;
               font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;
               color:rgb(var(--flasher-text));
               position:relative;">
      <p style="visibility:hidden; font-size:20px; line-height:1px; margin:0; padding:0;">---------------------------------------------------------------------</p>



      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0;">
        <label for="led" style="text-align:right; padding-right:12px;">LED Brightness:</label>
        <input id="led" type="range" min="0" max="100" step="10" value="50" style="width:min(160px, 100%); margin-top:2px; justify-self:start;">
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:8px;">
        <label for="wgt" style="text-align:right; padding-right:12px;">Transfer Amount:</label>
        <select id="wgt" style="justify-self:start; width:min(135px, 100%); border:1px solid #d1d5db; color:#000;">
          <option value="0">Entire Spool</option>
          <option value="1">1.0 kg</option>
          <option value="2">0.5 kg</option>
          <option value="3">0.25 kg</option>
        </select>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:5px;">
        <div></div>
        <label style="justify-self:start;"><input id="useFil" type="checkbox" checked> Use Filament Sensor</label>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:8px;">
        <label for="jin" style="text-align:right; padding-right:12px;">Completion Sound:</label>
        <select id="jin" style="justify-self:start; width:min(110px, 100%); border:1px solid #d1d5db; color:#000;">
          <option value="0">Off</option>
          <option value="1">Simple</option>
          <option value="2">Glissando</option>
          <option value="3">Star Wars</option>
        </select>
      </div>

      <hr class="section-divider" style="margin:12px 0;">

      <!-- Servo (PRO boards) -->
      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:8px;">
        <label style="text-align:right; padding-right:12px;">Servo Calibration:</label>
        <button id="servoCalBtn" class="mini-btn compact" style="justify-self:start;">Calibrate</button>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:8px;">
        <label style="text-align:right; padding-right:12px;">Step Distance:</label>
        <div class="stepper" style="justify-self:start;">
          <button id="servoStepMinus" class="mini-btn" type="button" aria-label="Decrease step distance"><span class="stepper-glyph">−</span></button>
          <span id="servoStepVal" class="stepper-value">1.75 mm</span>
          <button id="servoStepPlus" class="mini-btn" type="button" aria-label="Increase step distance"><span class="stepper-glyph">+</span></button>
        </div>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:8px;">
        <label for="servoHomeSetting" style="text-align:right; padding-right:12px;">Home Position:</label>
        <select id="servoHomeSetting" style="justify-self:start; width:min(110px, 100%); border:1px solid #d1d5db; color:#000;">
          <option value="R">Right</option>
          <option value="L">Left</option>
        </select>
      </div>

      <hr class="section-divider" style="margin:12px 0;">

      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:8px;">
        <label for="motor" style="text-align:right; padding-right:12px;">Motor Strength:</label>
        <div class="stepper" style="justify-self:start;">
          <button id="motorMinus" class="mini-btn" type="button" aria-label="Decrease motor strength"><span class="stepper-glyph">−</span></button>
          <span id="motorVal" class="stepper-value">100 %</span>
          <button id="motorPlus" class="mini-btn" type="button" aria-label="Increase motor strength"><span class="stepper-glyph">+</span></button>
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:0px;">
        <div></div>
        <label style="justify-self:start;"><input id="dir" type="checkbox"> Change Direction</label>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:2px;">
        <div></div>
        <label style="justify-self:start;"><input id="hs" type="checkbox"> High-Speed</label>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:8px;">
        <label for="autoStop" style="text-align:right; padding-right:12px;">Auto-Stop Sensitivity:</label>
        <select id="autoStop" style="justify-self:start; width:min(110px, 100%); border:1px solid #d1d5db; color:#000;">
          <option value="0">Off</option>
          <option value="1">Low</option>
          <option value="2">Medium</option>
          <option value="3">High</option>
        </select>
      </div>

      <hr class="section-divider" style="margin:12px 0;">

      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:8px;">
        <label for="fan" style="text-align:right; padding-right:12px;">Fan Speed:</label>
        <input id="fan" type="range" min="10" max="100" step="10" value="60" style="width:min(160px, 100%); margin-top:2px; justify-self:start;">
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; align-items:center; column-gap:0px; width:100%; margin:0; margin-top:0px;">
        <div></div>
        <label style="justify-self:start;"><input id="fanAlways" type="checkbox"> Fan Always On</label>
      </div>

      <!-- Speed slider moved to its own card -->
  </section>
  </div>

  </div>

  <div style="text-align:center; margin-top:2rem; margin-bottom:2rem; font-size:1rem; color:rgb(var(--text));">
    Powered by <a href="https://developer.chrome.com/docs/capabilities/bluetooth" target="_blank" style="color:rgb(var(--text)); text-decoration:underline;">WebBluetooth</a>
    <div style="margin-top:0.6rem;">
      <a href="https://github.com/LukasT03" target="_blank" style="color:rgb(var(--text)); text-decoration:underline; margin-right:1rem;">GitHub</a>
      <a href="https://lts-design.com" target="_blank" style="color:rgb(var(--text)); text-decoration:underline;">lts-design.com</a>
    </div>
  </div>

  <!-- Servo calibration modal -->
  <div id="servoModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Servo calibration">
    <div class="modal">
      <button id="servoModalClose" class="icon-btn modal-close" aria-label="Close">×</button>
      <div class="modal-header">
        <h2 class="modal-title">Calibrate End Positions</h2>
      </div>

      <div id="servoSideSegment" class="segmented" role="tablist" aria-label="Calibration side">
        <div id="servoSideIndicator" class="seg-indicator"></div>
        <button id="servoSideL" class="seg-btn is-selected" type="button" role="tab" aria-selected="true">Left Side</button>
        <button id="servoSideR" class="seg-btn" type="button" role="tab" aria-selected="false">Right Side</button>
      </div>

      <hr class="section-divider" style="margin:12px 0;">

      <div class="cal-row">
        <button id="servoArrowLeft" class="arrow-btn" type="button" aria-label="Decrease angle">‹</button>
        <div id="servoAngleText" class="angle-text">Angle: –°</div>
        <button id="servoArrowRight" class="arrow-btn" type="button" aria-label="Increase angle">›</button>
      </div>

      <p class="cal-desc">Adjust the left and right end stops so that the filament guide just touches the sides.</p>
    </div>
  </div>

  <!-- BLE Manager -->
  <script src="webble-manager.js"></script>

  <!-- Block A Logic (leicht angepasst) -->
  <script>
  (() => {
    const ui = {
      connect:  document.getElementById('wbConnect'),
      start:    document.getElementById('wbStart'),
      stop:     document.getElementById('wbStop'),
      prog:     document.getElementById('wbProg'),
      progBar:  document.getElementById('wbProgBar'),
      progPct:  document.getElementById('wbProgPct'),
      progRem:  document.getElementById('wbProgRem'),
      statusText: document.getElementById('wbStatusText'),
      buttons: document.getElementById('wbButtonGroup'),
      noSupport: document.getElementById('wbNoSupport'),
    };

    let statusHoldUntil = 0; // timestamp ms until which we force "Connected!"

    function setStatusTextAnimated(text, colorOrNull){
      const el = ui.statusText;
      if(!el) return;
      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const newColor = (colorOrNull === null) ? '' : colorOrNull;
      if (prefersReduced) { el.textContent = text; el.style.color = newColor; return; }
      if (el.textContent === text) { el.style.color = newColor; return; }
      el.style.transition = 'opacity 0.35s ease, transform 0.35s ease';
      el.style.opacity = '0';
      el.style.transform = 'scale(0.93)';
      setTimeout(() => {
        el.textContent = text;
        el.style.color = newColor;
        requestAnimationFrame(() => {
          el.style.opacity = '1';
          el.style.transform = 'scale(1)';
        });
      }, 120);
    }

    // Ensure initial percent text uses a space (e.g., "0 %") even before any JS updates
    if (ui.progPct) {
      const t = ui.progPct.textContent || '0';
      const n = parseInt(String(t).replace('%', '').trim(), 10);
      ui.progPct.textContent = (isNaN(n) ? 0 : n) + ' %';
    }

    function statusVisual(s){
      const code = (s && s.statusCode) ? String(s.statusCode).toUpperCase() : null;
      const txt  = (s && s.statusText) || null;
      const byFlags = s?.run ? {t:'Running…', c:'rgb(52,199,89)'} : (s && s.connected ? {t:'Connected', c:'rgb(52,199,89)'} : {t:'Not connected', c:''});
      if(!code) return { text: txt || byFlags.t, color: byFlags.c };
      switch(code){
        case 'R': return { text: txt || 'Running…',   color:'rgb(52,199,89)' };
        case 'P': return { text: txt || 'Paused',     color:'rgb(255,149,0)' };
        case 'U': return { text: txt || 'Updating…',  color:'rgb(14,122,254)' };
        case 'D': return { text: txt || 'Done!',      color:'rgb(52,199,89)' };
        case 'A': return { text: txt || 'Auto-Stop!', color:'rgb(254,56,60)' };
        case 'C': return { text: txt || 'Connected',  color:'rgb(52,199,89)' };
        case 'I': return { text: txt || 'Idle',       color:'rgb(52,199,89)' };
        default:  return { text: txt || byFlags.t,    color: byFlags.c };
      }
    }

    const isIOS = /iPad|iPhone|iPod|iOS/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isWebKit = /AppleWebKit/i.test(navigator.userAgent);
    const isIOSWebKit = isIOS && isWebKit;
    if (isIOSWebKit) {
      if (ui.buttons) ui.buttons.style.display = 'none';
      if (ui.noSupport) ui.noSupport.style.display = 'block';
      return;
    }
    if (ui.buttons) ui.buttons.style.display = 'block';
    if (ui.noSupport) ui.noSupport.style.display = 'none';
    const secure = (typeof window.isSecureContext === 'boolean') ? window.isSecureContext : (location.protocol === 'https:' || location.hostname === 'localhost');
    const hasBLE = !!(navigator.bluetooth && typeof navigator.bluetooth.requestDevice === 'function');
    const webBleSupported = hasBLE && secure && !isIOSWebKit;
    if(!webBleSupported){
      if(ui.buttons) ui.buttons.style.display = 'none';
      if(ui.noSupport) ui.noSupport.style.display = 'block';
      return;
    }

    function setConnected(on, justConnected){
      ui.stop.disabled  = !on;
      ui.start.disabled = !on;
      if (ui.connect) ui.connect.textContent = on ? 'Disconnect' : 'Connect';
      if (!on) { ui.start.textContent = 'Start'; }
      if(on && justConnected){
        statusHoldUntil = Date.now() + 1500;
      }
      if (ui.statusText) {
        if (on) {
          const withinHold = statusHoldUntil && Date.now() < statusHoldUntil;
          if (withinHold) {
            setStatusTextAnimated('Connected!', 'rgb(52,199,89)');
          } else {
            setStatusTextAnimated('Connected', '');
          }
        } else {
          setStatusTextAnimated('Not connected', '');
        }
      }
      if(!on && ui.progBar){ ui.progBar.style.width = '0%'; }
      if(!on && ui.progPct){ ui.progPct.textContent = '0 %'; }
    }

    if (ui.connect) {
      ui.connect.addEventListener('click', async () => {
        const st = window.webble.getState();
        if (st.connected) {
          window.webble.disconnect();
        } else {
          try { await window.webble.connect(); } catch(e) { alert(e.message||e); }
        }
      });
    }
    ui.start.addEventListener('click', () => {
      const label = (ui.start.textContent || '').trim();
      if (label === 'Pause') {
        window.webble.pause();
      } else {
        window.webble.start();
      }
    });
    ui.stop.addEventListener('click',  () => window.webble.stop());

    window.webble.on('connected',   () => {
      setConnected(true, true);
    });
    window.webble.on('disconnected',() => {
      statusHoldUntil = 0;
      setConnected(false);
    });
    window.webble.on('status', (s) => {
      const isConn = window.webble.getState().connected === true;
      const blockedByFil = !!s.useFil && !s.hasFilament;
      const isUpdating = (String(s.statusCode || s.code || '').toUpperCase() === 'U') || !!s.updating;
      ui.start.disabled = !isConn || blockedByFil || isUpdating;
      ui.stop.disabled  = !isConn || isUpdating;
      const isRunning = (String(s.statusCode || s.code || '').toUpperCase() === 'R') || !!s.run;
      ui.start.textContent = isRunning ? 'Pause' : 'Start';
      if (ui.progBar) {
        const p = Math.max(0, Math.min(100, Number(s.progress ?? s.PROG ?? 0)));
        ui.progBar.style.width = p + '%';

        const code = String(s.statusCode || s.code || '').toUpperCase();
        if (code === 'I') {
          ui.progBar.style.width = '0%';
        }
        if (code === 'D') {
          ui.progBar.style.background = 'rgb(52,199,89)';
        } else if (code === 'P') {
          ui.progBar.style.background = 'rgb(255,149,0)';
        } else if (code === 'A') {
          ui.progBar.style.background = 'rgb(254,56,60)';
        } else {
          ui.progBar.style.background = '#0c4c98';
        }
      }
      if (ui.progPct) {
        const pct = Math.round(Number(s.progress ?? s.PROG ?? 0));
        ui.progPct.textContent = pct + ' %';
      }
      if (ui.progRem) {
        let rem = s.remaining ?? null;
        if (typeof rem === 'number' && !isNaN(rem)) {
          const m = String(Math.floor(rem / 60)).padStart(2,'0');
          const sec = String(Math.floor(rem % 60)).padStart(2,'0');
          ui.progRem.textContent = `-${m}:${sec}`;
        }
      }
      const now = Date.now();
      if (ui.statusText && isConn && statusHoldUntil && now < statusHoldUntil) {
        setStatusTextAnimated('Connected!', 'rgb(52,199,89)');
      } else if (ui.statusText) {
        const vis = statusVisual({ ...s, connected: isConn });
        setStatusTextAnimated(vis.text, '');
      }
    });

    setConnected(window.webble.getState().connected);
    (function initProgress(){
      if(!ui.progBar || !window.webble?.getState) return;
      const st = window.webble.getState();
      const p = Math.max(0, Math.min(100, Number(st.progress ?? 0)));
      ui.progBar.style.width = p + '%';
      if(ui.progPct){
        const pct = Math.round(Number(st.progress ?? 0));
        ui.progPct.textContent = pct + ' %';
      }
      const isRunningInit = (String(st.statusCode || '').toUpperCase() === 'R') || !!st.run;
      ui.start.textContent = isRunningInit ? 'Pause' : 'Start';
      const isUpdatingInit = (String(st.statusCode || '').toUpperCase() === 'U') || !!st.updating;
      ui.start.disabled = !window.webble.getState?.().connected || isUpdatingInit || (!!st.useFil && !st.hasFilament);
      ui.stop.disabled  = !window.webble.getState?.().connected || isUpdatingInit;
      if(ui.progRem && typeof st.remaining === 'number'){
        const m = String(Math.floor(st.remaining/60)).padStart(2,'0');
        const sec = String(Math.floor(st.remaining%60)).padStart(2,'0');
        ui.progRem.textContent = `-${m}:${sec}`;
      }
      if(ui.statusText){
        const stc = window.webble.getState?.() || {};
        const vis = statusVisual(stc);
        setStatusTextAnimated(vis.text, '');
      }
    })();
  })();
  </script>

  <!-- Block B Logic (unverändert übernommen) -->
  <script>
  (() => {
    function whenWebbleReady(fn){
      if (window.webble && window.webble.__ready) { fn(); return; }
      const iv = setInterval(() => {
        if (window.webble && window.webble.__ready) { clearInterval(iv); fn(); }
      }, 50);
      setTimeout(() => clearInterval(iv), 5000);
    }

    // Info rendering removed

    function bindWithWebble(){
      // WiFi / Update UI
      const wifiScanBtn  = document.getElementById('wifiScanBtn');
      const wifiSsid     = document.getElementById('wifiSsid');
      const wifiPass     = document.getElementById('wifiPass');
      const wifiSendBtn  = document.getElementById('wifiSendBtn');
      const wifiStatus   = document.getElementById('wifiStatus');

      // Status pills
      const pillConnSub = document.getElementById('pillConnSub');
      const pillFilSub  = document.getElementById('pillFilSub');
      const pillConnIcon = document.getElementById('pillConnIcon');
      const pillFilIcon  = document.getElementById('pillFilIcon');
      function setWifiStatusText(t){
        if (!wifiStatus) return;
        wifiStatus.textContent = (t && String(t).trim().length) ? String(t) : '\u00A0';
      }

      function populateSsids(ssids, selected){
      function updateStatusPills(s){
        try {
          const isConn = !!(s && s.connected);
          if (pillConnSub) pillConnSub.textContent = isConn ? 'Connected' : 'Disconnected';
          if (pillConnIcon) pillConnIcon.src = isConn ? 'antenna.png' : 'antenna-slash.png';

          // Filament: prefer HAS_FIL boolean if present; otherwise show placeholder
          let has = null;
          if (s && typeof s.hasFilament === 'boolean') has = s.hasFilament;
          else if (s && typeof s.HAS_FIL === 'boolean') has = s.HAS_FIL;

          if (pillFilSub) {
            if (has === true) pillFilSub.textContent = 'Detected';
            else if (has === false) pillFilSub.textContent = 'Not Detected';
            else pillFilSub.textContent = '—';
          }
          if (pillFilIcon) {
            if (has === true) pillFilIcon.src = 'checkmark.png';
            else pillFilIcon.src = 'xmark.png';
          }
        } catch(_) {}
      }
        if (!wifiSsid) return;
        const cur = (selected != null) ? String(selected) : String(wifiSsid.value || '');
        const keep = cur;
        wifiSsid.innerHTML = '<option value="" ' + (keep ? '' : 'selected') + '>Select…</option>';
        (Array.isArray(ssids) ? ssids : []).forEach(s => {
          const v = String(s);
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          if (v === keep) opt.selected = true;
          wifiSsid.appendChild(opt);
        });
      }

      if (wifiScanBtn) {
        wifiScanBtn.addEventListener('click', async () => {
          try {
            setWifiStatusText('Scanning…');
            await window.webble.wifiScan();
          } catch(e) {
            setWifiStatusText('Scan failed');
            console.error(e);
          }
        });
      }

      if (wifiSsid) {
        wifiSsid.addEventListener('change', async (e) => {
          const ssid = String(e.target.value || '');
          if (!ssid) return;
          try {
            await window.webble.sendWiFiSSID(ssid);
            setWifiStatusText('SSID sent');
          } catch(err) {
            setWifiStatusText('SSID failed');
            console.error(err);
          }
        });
      }

      if (wifiSendBtn) {
        wifiSendBtn.addEventListener('click', async () => {
          const ssid = String(wifiSsid?.value || '').trim();
          const pass = String(wifiPass?.value || '');
          if (!ssid) { setWifiStatusText('Select a network'); return; }
          try {
            setWifiStatusText('Sending…');
            await window.webble.sendWiFiSSID(ssid);
            await window.webble.sendWiFiPassword(pass);
            await window.webble.wifiConnect();
            setWifiStatusText('Connecting…');
          } catch(e) {
            setWifiStatusText('Send failed');
            console.error(e);
          }
        });
      }

      // Update UI initially
      try {
        const w = window.webble.getWiFi?.();
        populateSsids(w?.ssids || [], w?.ssid || '');
        if (w?.connected && w?.ssid) setWifiStatusText('Connected: ' + w.ssid);
      } catch(_) {}
      const led = document.getElementById('led');
      const useFil = document.getElementById('useFil');
      const motorVal = document.getElementById('motorVal');
      const motorMinus = document.getElementById('motorMinus');
      const motorPlus  = document.getElementById('motorPlus');
      const dir = document.getElementById('dir');
      const hs = document.getElementById('hs');
      const autoStop = document.getElementById('autoStop');
      const jin = document.getElementById('jin');
      const wgt = document.getElementById('wgt');
      const fan = document.getElementById('fan');
      const fanAlways = document.getElementById('fanAlways');
      const speed = document.getElementById('speed');
      const speedVal = document.getElementById('speedVal');

      // Servo UI
      const servoCalBtn = document.getElementById('servoCalBtn');
      const servoStepMinus = document.getElementById('servoStepMinus');
      const servoStepPlus  = document.getElementById('servoStepPlus');
      const servoStepVal   = document.getElementById('servoStepVal');

      // Modal
      const servoModalBackdrop = document.getElementById('servoModalBackdrop');
      const servoModalClose    = document.getElementById('servoModalClose');
      const servoSideL         = document.getElementById('servoSideL');
      const servoSideR         = document.getElementById('servoSideR');
      const servoArrowLeft     = document.getElementById('servoArrowLeft');
      const servoArrowRight    = document.getElementById('servoArrowRight');
      const servoAngleText     = document.getElementById('servoAngleText');
      const servoHomeSetting   = document.getElementById('servoHomeSetting');
      const servoSideSegment   = document.getElementById('servoSideSegment');
      const servoSideIndicator = document.getElementById('servoSideIndicator');

      const uiEditing = new Set();
      const beginUI = (key) => { uiEditing.add(key); try { window.webble.beginEdit(key); } catch(_){} };
      const endUI   = (key) => { uiEditing.delete(key); try { window.webble.commitEdit(key); } catch(_){} };
      const isUIEditing = (key) => uiEditing.has(key);

      const pending = new Map();
      function setPending(key, val, ms = 900) {
        pending.set(key, { val: String(val), until: Date.now() + ms });
      }
      function shouldApply(key, incomingVal) {
        const p = pending.get(key);
        if (!p) return true;
        if (Date.now() > p.until) { pending.delete(key); return true; }
        if (String(incomingVal) === p.val) { pending.delete(key); return true; }
        return false;
      }

      function bindSlider(el, key, setter, onLocal){
        el.addEventListener('pointerdown', () => beginUI(key));
        if (onLocal) el.addEventListener('input', e => onLocal(e.target.value));
        const commit = (v) => { setter(v); endUI(key); };
        el.addEventListener('pointerup',   e => commit(e.target.value));
        el.addEventListener('change',      e => commit(e.target.value));
        el.addEventListener('pointercancel', () => endUI(key));
        el.addEventListener('keyup', (e)=>{ if(e.key==='Enter' || e.key===' ') commit(e.target.value); });
      }
      function bindCheckbox(el, key, setter){
        el.addEventListener('pointerdown', () => beginUI(key));
        el.addEventListener('change', e => { setter(e.target.checked); endUI(key); });
        el.addEventListener('pointercancel', () => endUI(key));
        el.addEventListener('keyup', (e)=>{ if(e.key==='Enter' || e.key===' ') { setter(el.checked); endUI(key);} });
        el.addEventListener('blur', () => { if (uiEditing.has(key)) endUI(key); });
      }
      function bindSelect(el, key, setter){
        el.addEventListener('pointerdown', () => beginUI(key));
        el.addEventListener('focusin',   () => beginUI(key));
        el.addEventListener('change',    e => { setter(e.target.value); endUI(key); });
        el.addEventListener('blur',      () => { if (uiEditing.has(key)) endUI(key); });
      }

      bindSlider(led,   'LED',     (v)=>window.webble.setLED(v));
      bindCheckbox(useFil,'USE_FIL',(on)=>window.webble.setUseFil(on));
      // Motor stepper logic replaces slider binding
      bindCheckbox(dir, 'DIR',     (on)=>window.webble.setDir(on));
      bindCheckbox(hs,  'HS',      (on)=>window.webble.setHighSpeed(on));
      bindSelect(autoStop, 'TRQ', (v) => { setPending('TRQ', v); window.webble.setTorque(v); });
      bindSelect(jin,      'JIN', (v) => { setPending('JIN', v); window.webble.setJingle(v); });
      bindSelect(wgt,      'WGT', (v) => { setPending('WGT', v); window.webble.setTargetWeight(v); });
      // Servo home position
      if (servoHomeSetting) {
        bindSelect(servoHomeSetting, 'SV_HOME', (v) => {
          setPending('SV_HOME', v);
          window.webble.setServoHome(v);
        });
      }
      bindSlider(fan,   'FAN_SPD', (v)=>window.webble.setFanSpeed(v));
      bindCheckbox(fanAlways,'FAN_ALW',(on)=>window.webble.setFanAlways(on));
      bindSlider(speed, 'SPD',     (v)=>window.webble.setSpeed(v), (v)=>{ speedVal.textContent = v + ' %'; });
      // Motor strength +/- buttons
      let motorLocal = 100;
      function clampPow(v){
        v = Number(v);
        if (!Number.isFinite(v)) return 100;
        return Math.max(80, Math.min(120, Math.round(v / 10) * 10));
      }
      function updateMotorUI(){
        if (motorVal) motorVal.textContent = String(motorLocal) + ' %';
      }
      function commitMotor(){
        beginUI('POW');
        window.webble.setPower(motorLocal);
        endUI('POW');
      }
      updateMotorUI();

      if (motorMinus) motorMinus.addEventListener('click', () => {
        motorLocal = clampPow(motorLocal - 10);
        updateMotorUI();
        commitMotor();
      });
      if (motorPlus) motorPlus.addEventListener('click', () => {
        motorLocal = clampPow(motorLocal + 10);
        updateMotorUI();
        commitMotor();
      });

      function fmtMm(v){
        const n = Number(v);
        if (!Number.isFinite(n)) return '– mm';
        return n.toFixed(2) + ' mm';
      }

      function openServoModal(){
        if (!servoModalBackdrop) return;

        // When opening, align modal picker with current Home Position
        try {
          const hv = (servoHomeSetting && servoHomeSetting.value)
            ? String(servoHomeSetting.value).trim().toUpperCase()
            : null;
          if (hv === 'R' || hv === 'L') {
            setSide(hv);
          }
        } catch(_) {}

        servoModalBackdrop.classList.add('show');
      }
      function closeServoModal(){
        if (!servoModalBackdrop) return;
        servoModalBackdrop.classList.remove('show');

        // When closing, return servo to Home position
        try {
          if (window.webble && typeof window.webble.servoGoto === 'function') {
            window.webble.servoGoto('HOME');
          }
        } catch(_) {}
      }

      if (servoCalBtn) {
        servoCalBtn.addEventListener('click', () => openServoModal());
      }
      if (servoModalClose) servoModalClose.addEventListener('click', closeServoModal);
      if (servoModalBackdrop) {
        servoModalBackdrop.addEventListener('click', (e) => {
          if (e.target === servoModalBackdrop) closeServoModal();
        });
      }
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeServoModal();
      });

      // Step distance +/- buttons
      let servoStepLocal = 1.75;
      function updateServoStepUI(){
        if (servoStepVal) servoStepVal.textContent = fmtMm(servoStepLocal);
      }
      updateServoStepUI();

      const stepDelta = 0.01;
      const stepMin = 0.05;
      const stepMax = 20.0;

      function commitServoStep(){
        try { beginUI('SV_STP'); } catch(_){}
        window.webble.setServoStepMm(servoStepLocal);
        try { endUI('SV_STP'); } catch(_){}
      }

      if (servoStepMinus) servoStepMinus.addEventListener('click', () => {
        servoStepLocal = Math.max(stepMin, +(servoStepLocal - stepDelta).toFixed(2));
        updateServoStepUI();
        commitServoStep();
      });
      if (servoStepPlus) servoStepPlus.addEventListener('click', () => {
        servoStepLocal = Math.min(stepMax, +(servoStepLocal + stepDelta).toFixed(2));
        updateServoStepUI();
        commitServoStep();
      });

      // Servo calibration (segmented + arrows)
      let calSide = 'L'; // 'L' or 'R'
      let angleL = 175;
      let angleR = 5;

      function setSide(side){
        calSide = (side === 'R') ? 'R' : 'L';

        // Side selection should also move the servo to that side
        try {
          if (window.webble && typeof window.webble.servoGoto === 'function') {
            window.webble.servoGoto(calSide);
          }
        } catch(_) {}

        if (servoSideL) {
          const on = calSide === 'L';
          servoSideL.classList.toggle('is-selected', on);
          servoSideL.setAttribute('aria-selected', on ? 'true' : 'false');
        }
        if (servoSideR) {
          const on = calSide === 'R';
          servoSideR.classList.toggle('is-selected', on);
          servoSideR.setAttribute('aria-selected', on ? 'true' : 'false');
        }

        if (servoSideIndicator) {
          const index = (calSide === 'L') ? 0 : 1;
          servoSideIndicator.style.transform = `translateX(${index * 100}%)`;
        }

        updateAngleText();
      }

      function updateAngleText(){
        const v = (calSide === 'L') ? angleL : angleR;
        if (servoAngleText) servoAngleText.textContent = `Angle: ${Math.round(v)}°`;
      }

      function commitAngle(){
        if (calSide === 'L') {
          beginUI('SV_L');
          window.webble.setServoAngleL(angleL);
          endUI('SV_L');
        } else {
          beginUI('SV_R');
          window.webble.setServoAngleR(angleR);
          endUI('SV_R');
        }
      }

      function nudgeAngle(delta){
        if (calSide === 'L') {
          angleL = Math.max(0, Math.min(180, Math.round(angleL + delta)));
        } else {
          angleR = Math.max(0, Math.min(180, Math.round(angleR + delta)));
        }
        updateAngleText();
        commitAngle();
      }

      if (servoSideL) servoSideL.addEventListener('click', () => setSide('L'));
      if (servoSideR) servoSideR.addEventListener('click', () => setSide('R'));
      if (servoArrowLeft)  servoArrowLeft.addEventListener('click', () => nudgeAngle(+1));
      if (servoArrowRight) servoArrowRight.addEventListener('click', () => nudgeAngle(-1));

      // Initialize
      setSide('L');

      window.webble.on('status', s => {
        updateStatusPills(s);
        // WiFi / Update card
        try {
          const isConn = window.webble.getState().connected === true;
          const scanning = !!s.isScanningForSSIDs;
          if (wifiScanBtn) wifiScanBtn.disabled = !isConn || scanning;
          if (wifiSsid) wifiSsid.disabled = !isConn || scanning;
          if (wifiPass) wifiPass.disabled = !isConn;
          if (wifiSendBtn) wifiSendBtn.disabled = !isConn || scanning;

          if (Array.isArray(s.availableSSIDs)) {
            populateSsids(s.availableSSIDs, s.wifiSSID || '');
          }

          if (scanning) {
            setWifiStatusText('Scanning…');
          } else if (s.wifiConnected) {
            setWifiStatusText(s.wifiSSID ? ('Connected: ' + s.wifiSSID) : 'Connected');
          } else if (s.wifiConnectionResult != null) {
            setWifiStatusText(s.wifiConnectionResult ? 'Connected' : 'Connection failed');
          } else if (s.wifiLastResult != null) {
            setWifiStatusText(s.wifiLastResult ? 'OK' : 'Failed');
          }
        } catch(_) {}
        if (!isUIEditing('LED'))      led.value = s.led ?? 50;
        if (!isUIEditing('USE_FIL'))  useFil.checked = (s.useFil !== false);
        if (!isUIEditing('POW')) {
          motorLocal = clampPow(s.pow ?? 100);
          updateMotorUI();
        }
        if (!isUIEditing('DIR'))      dir.checked = !!s.dir;
        if (!isUIEditing('HS'))       hs.checked = !!s.hs;
        if (!isUIEditing('TRQ')) { const v = String(s.trq ?? 0); if (shouldApply('TRQ', v)) autoStop.value = v; }
        if (!isUIEditing('JIN')) { const v = String(s.jin ?? 0); if (shouldApply('JIN', v)) jin.value = v; }
        if (!isUIEditing('WGT')) { const v = String(s.targetWeight ?? s.wgt ?? s.WGT ?? s.targetweight ?? 0); if (shouldApply('WGT', v)) wgt.value = v; }
        if (!isUIEditing('FAN_SPD'))  fan.value = s.fan ?? 80;
        if (!isUIEditing('FAN_ALW'))  fanAlways.checked = !!s.fanAlways;
        if (!isUIEditing('SPD'))      { speed.value = s.speed ?? 80; speedVal.textContent = (s.speed ?? 80) + ' %'; }

        // Servo values
        if (!isUIEditing('SV_STP')) {
          const v = Number(s.servoStepMm ?? s.SV_STP);
          if (Number.isFinite(v)) {
            servoStepLocal = v;
            updateServoStepUI();
          }
        }
        if (!isUIEditing('SV_L') && typeof (s.servoAngleL ?? s.SV_L) === 'number') {
          angleL = Math.max(0, Math.min(180, Math.round(Number(s.servoAngleL ?? s.SV_L))));
          if (calSide === 'L') updateAngleText();
        }
        if (!isUIEditing('SV_R') && typeof (s.servoAngleR ?? s.SV_R) === 'number') {
          angleR = Math.max(0, Math.min(180, Math.round(Number(s.servoAngleR ?? s.SV_R))));
          if (calSide === 'R') updateAngleText();
        }
        if (!isUIEditing('SV_HOME') && servoHomeSetting && typeof (s.servoHome ?? s.SV_HOME) === 'string') {
          const h = String(s.servoHome ?? s.SV_HOME).trim().toUpperCase();
          if ((h === 'R' || h === 'L') && shouldApply('SV_HOME', h)) {
            servoHomeSetting.value = h;
          }
        }

        // Disable servo controls when not connected
        const isConn = window.webble.getState().connected === true;
        if (servoCalBtn) servoCalBtn.disabled = !isConn;
        if (servoStepMinus) servoStepMinus.disabled = !isConn;
        if (servoStepPlus) servoStepPlus.disabled = !isConn;
        if (servoSideL) servoSideL.disabled = !isConn;
        if (servoSideR) servoSideR.disabled = !isConn;
        if (servoArrowLeft)  servoArrowLeft.disabled = !isConn;
        if (servoArrowRight) servoArrowRight.disabled = !isConn;
        if (servoHomeSetting) servoHomeSetting.disabled = !isConn;
        if (motorMinus) motorMinus.disabled = !isConn;
        if (motorPlus)  motorPlus.disabled = !isConn;
        if (servoSideSegment) servoSideSegment.classList.toggle('is-disabled', !isConn);
      });

      try {
        const initial = window.webble.getState();
        updateStatusPills(initial);

        // Initialize servo UI
        if (typeof initial.servoStepMm === 'number') {
          servoStepLocal = initial.servoStepMm;
          updateServoStepUI();
        }
        if (typeof initial.servoAngleL === 'number') angleL = Math.max(0, Math.min(180, Math.round(initial.servoAngleL)));
        if (typeof initial.servoAngleR === 'number') angleR = Math.max(0, Math.min(180, Math.round(initial.servoAngleR)));
        updateAngleText();
        if (servoHomeSetting && typeof initial.servoHome === 'string') {
          const h = String(initial.servoHome).trim().toUpperCase();
          if (h === 'R' || h === 'L') servoHomeSetting.value = h;
        }
        // Initialize motor stepper UI
        if (typeof initial.pow === 'number') {
          motorLocal = clampPow(initial.pow);
          updateMotorUI();
        }
      } catch(_) {}
    }

    // Info button and popup handlers removed

    whenWebbleReady(bindWithWebble);
  })();
  </script>
</body>
</html>